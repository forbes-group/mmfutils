<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>&quot;Notes&quot;</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">"Notes"</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#developer-notes" id="toc-developer-notes">Developer
Notes</a></li>
<li><a href="#to-do" id="toc-to-do">To Do</a></li>
<li><a href="#tldr" id="toc-tldr">TL;DR</a></li>
<li><a href="#tools" id="toc-tools">Tools</a></li>
<li><a href="#python-dependencies" id="toc-python-dependencies">Python
Dependencies</a>
<ul>
<li><a href="#pdm" id="toc-pdm">PDM</a></li>
</ul></li>
<li><a href="#conda-dependencies" id="toc-conda-dependencies">Conda
Dependencies</a>
<ul>
<li><a href="#makefile" id="toc-makefile">Makefile</a></li>
</ul></li>
<li><a href="#managing-multiple-versions-of-python"
id="toc-managing-multiple-versions-of-python">Managing Multiple Versions
of Python</a>
<ul>
<li><a href="#testing" id="toc-testing">Testing</a>
<ul>
<li><a href="#github-ci" id="toc-github-ci">GitHub CI</a></li>
</ul></li>
</ul></li>
<li><a href="#tools-1" id="toc-tools-1">Tools</a>
<ul>
<li><a href="#useful-tools" id="toc-useful-tools">Useful Tools</a></li>
</ul></li>
<li><a href="#working-environment-condapip-and-all-that"
id="toc-working-environment-condapip-and-all-that">Working Environment
(Conda/Pip and all that)</a>
<ul>
<li><a href="#option-1-recommendation-as-of-march-2023"
id="toc-option-1-recommendation-as-of-march-2023">Option 1
(Recommendation as of March 2023)</a></li>
<li><a href="#option-2-experimental"
id="toc-option-2-experimental">Option 2 (experimental)</a>
<ul>
<li><a href="#caveats" id="toc-caveats">Caveats</a></li>
</ul></li>
<li><a href="#option-3-old-recommendation"
id="toc-option-3-old-recommendation">Option 3 (old
recommendation)</a></li>
<li><a href="#option-3-incomplete" id="toc-option-3-incomplete">Option 3
(incomplete)</a>
<ul>
<li><a href="#testing-for-option-2"
id="toc-testing-for-option-2">Testing for Option 2</a></li>
</ul></li>
<li><a href="#option-3" id="toc-option-3">Option 3</a></li>
<li><a href="#references" id="toc-references">References</a></li>
<li><a href="#reproducible-computing"
id="toc-reproducible-computing">Reproducible Computing</a>
<ul>
<li><a href="#conda-pack" id="toc-conda-pack">Conda-Pack</a></li>
</ul></li>
</ul></li>
<li><a href="#packaging" id="toc-packaging">Packaging</a>
<ul>
<li><a href="#distribution" id="toc-distribution">Distribution</a></li>
<li><a href="#to-do-1" id="toc-to-do-1">To Do</a></li>
<li><a href="#version-number" id="toc-version-number">Version
Number</a></li>
</ul></li>
<li><a href="#documentation-read-the-docs"
id="toc-documentation-read-the-docs">Documentation (Read the Docs)</a>
<ul>
<li><a href="#jupyter-book" id="toc-jupyter-book">Jupyter Book</a>
<ul>
<li><a href="#images" id="toc-images">Images</a></li>
</ul></li>
</ul></li>
<li><a href="#repositories" id="toc-repositories">Repositories</a>
<ul>
<li><a href="#badges" id="toc-badges">Badges</a></li>
<li><a href="#continuous-integration-ci"
id="toc-continuous-integration-ci">Continuous Integration (CI)</a>
<ul>
<li><a href="#coverage" id="toc-coverage">Coverage</a></li>
</ul></li>
<li><a href="#references-1" id="toc-references-1">References</a></li>
</ul></li>
<li><a href="#testing-1" id="toc-testing-1">Testing</a>
<ul>
<li><a href="#tests__init__.py"
id="toc-tests__init__.py"><code>tests/__init__.py</code></a></li>
<li><a href="#nox" id="toc-nox">Nox</a>
<ul>
<li><a href="#matrix-testing" id="toc-matrix-testing">Matrix
Testing</a></li>
<li><a href="#gotchas" id="toc-gotchas">Gotchas</a></li>
</ul></li>
<li><a href="#documentation"
id="toc-documentation">Documentation</a></li>
</ul></li>
<li><a href="#profiling-incomplete"
id="toc-profiling-incomplete">Profiling (Incomplete)</a></li>
<li><a href="#releases" id="toc-releases">Releases</a></li>
<li><a href="#mmfutils-this-package"
id="toc-mmfutils-this-package"><code>mmfutils</code>: This Package</a>
<ul>
<li><a href="#dependencies" id="toc-dependencies">Dependencies</a></li>
<li><a href="#the-development-process-makefiles"
id="toc-the-development-process-makefiles">The Development Process:
Makefiles</a>
<ul>
<li><a href="#details" id="toc-details">Details</a></li>
<li><a href="#things-that-did-not-work"
id="toc-things-that-did-not-work">Things that Did Not Work</a></li>
<li><a href="#issues" id="toc-issues">Issues</a></li>
</ul></li>
<li><a href="#poetry" id="toc-poetry">Poetry</a></li>
<li><a href="#soft-dependencies" id="toc-soft-dependencies">Soft
Dependencies</a></li>
<li><a href="#issues-1" id="toc-issues-1">Issues:</a></li>
<li><a href="#references-2" id="toc-references-2">References</a></li>
</ul></li>
<li><a href="#testing-2" id="toc-testing-2">Testing</a>
<ul>
<li><a href="#issues-2" id="toc-issues-2">Issues:</a></li>
</ul></li>
<li><a href="#github" id="toc-github">GitHub</a></li>
<li><a href="#issues-3" id="toc-issues-3">Issues:</a>
<ul>
<li><a href="#pyfftw" id="toc-pyfftw">pyFFTW</a></li>
<li><a href="#sleep" id="toc-sleep">Sleep</a></li>
</ul></li>
<li><a href="#cocalc" id="toc-cocalc">CoCalc</a>
<ul>
<li><a href="#implementation-details"
id="toc-implementation-details">Implementation Details</a></li>
</ul></li>
<li><a href="#reference" id="toc-reference">Reference</a>
<ul>
<li><a href="#conda-issues" id="toc-conda-issues">Conda Issues</a></li>
<li><a href="#black-issues" id="toc-black-issues">Black Issues</a></li>
<li><a href="#pdm-issues" id="toc-pdm-issues">PDM Issues</a></li>
<li><a href="#poetry-issues" id="toc-poetry-issues">Poetry
Issues</a></li>
<li><a href="#pipx-issues" id="toc-pipx-issues">PipX Issues</a></li>
<li><a href="#condax-issues" id="toc-condax-issues">CondaX
Issues</a></li>
<li><a href="#cocalc-issues" id="toc-cocalc-issues">CoCalc
Issues</a></li>
</ul></li>
<li><a href="#odds-and-ends" id="toc-odds-and-ends">Odds and
Ends</a></li>
<li><a href="#references-3" id="toc-references-3">References</a></li>
</ul>
</nav>
<h1 id="developer-notes">Developer Notes</h1>
<p><a
href="https://mmfutils.readthedocs.io/en/latest/?badge=latest"><img
src="https://readthedocs.org/projects/mmfutils/badge/?version=latest"
alt="Documentation Status" /></a> <a
href="https://github.com/mforbes/mmfutils-fork/actions/workflows/tests.yml"><img
src="https://github.com/mforbes/mmfutils-fork/actions/workflows/tests.yml/badge.svg?branch=topic%2F0.6.0%2Fgithub_ci"
alt="Tests" /></a> <a
href="https://lgtm.com/projects/g/forbes-group/mmfutils/context:python"><img
src="https://img.shields.io/lgtm/grade/python/g/forbes-group/mmfutils.svg?logo=lgtm&amp;logoWidth=18"
alt="Language grade: Python" /></a> <a
href="https://lgtm.com/projects/g/forbes-group/mmfutils/context:python"><img
src="https://img.shields.io/lgtm/grade/python/g/mforbes/mmfutils-fork.svg?logo=lgtm&amp;logoWidth=18"
alt="Language grade: Python" /></a> <a
href="https://black.readthedocs.io/en/stable/"><img
src="https://img.shields.io/badge/code%20style-black-000000.svg"
alt="Code style: black" /></a></p>
<p>These are some notes for developers and a general discussion about
some of the design choices I have made regarding things such as file
hierarchy, packaging tools etc. I intend for this file to document my
choices and discussions about these issues for all projects. (Other
projects should refer here for this discussion.)</p>
<details>
<summary>
Table of Contents
</summary>
<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
<ul>
<li><a href="#to-do">To Do</a></li>
<li><a href="#tldr">TL;DR</a></li>
<li><a href="#tools">Tools</a></li>
<li><a href="#python-dependencies">Python Dependencies</a></li>
<li><a href="#conda-dependencies">[Conda][] Dependencies</a></li>
<li><a href="#simplified-approach-july-2023">Simplified Approach (July
2023)</a>
<ul>
<li><a href="#makefile">Makefile</a></li>
</ul></li>
<li><a href="#tools-1">Tools</a>
<ul>
<li><a href="#useful-tools">Useful Tools</a></li>
</ul></li>
<li><a href="#working-environment-condapip-and-all-that">Working
Environment (Conda/Pip and all that)</a>
<ul>
<li><a href="#option-1-recommendation-as-of-march-2023">Option 1
(Recommendation as of March 2023)</a></li>
<li><a href="#option-2-experimental">Option 2 (experimental)</a>
<ul>
<li><a href="#caveats">Caveats</a></li>
</ul></li>
<li><a href="#option-3-old-recommendation">Option 3 (old
recommendation)</a></li>
<li><a href="#option-3-incomplete">Option 3 (incomplete)</a>
<ul>
<li><a href="#testing-for-option-2">Testing for Option 2</a></li>
</ul></li>
<li><a href="#option-3">Option 3</a></li>
<li><a href="#references">References</a></li>
<li><a href="#reproducible-computing">Reproducible Computing</a>
<ul>
<li><a href="#conda-pack">Conda-Pack</a></li>
</ul></li>
</ul></li>
<li><a href="#packaging">Packaging</a>
<ul>
<li><a href="#distribution">Distribution</a></li>
<li><a href="#to-do-1">To Do</a></li>
<li><a href="#version-number">Version Number</a></li>
</ul></li>
<li><a href="#documentation-read-the-docs">Documentation ([Read the
Docs][])</a>
<ul>
<li><a href="#jupyter-book">Jupyter Book</a>
<ul>
<li><a href="#images">Images</a></li>
</ul></li>
</ul></li>
<li><a href="#repositories">Repositories</a>
<ul>
<li><a href="#badges">Badges</a></li>
<li><a href="#continuous-integration-ci">Continuous Integration (CI)</a>
<ul>
<li><a href="#coverage">Coverage</a></li>
</ul></li>
<li><a href="#references-1">References</a></li>
</ul></li>
<li><a href="#testing">Testing</a>
<ul>
<li><a href="#tests__init__py"><code>tests/__init__.py</code></a></li>
<li><a href="#nox">Nox</a>
<ul>
<li><a href="#matrix-testing">Matrix Testing</a></li>
<li><a href="#gotchas">Gotchas</a></li>
</ul></li>
<li><a href="#documentation">Documentation</a></li>
</ul></li>
<li><a href="#profiling-incomplete">Profiling (Incomplete)</a></li>
<li><a href="#releases">Releases</a></li>
<li><a href="#mmfutils-this-package"><code>mmfutils</code>: This
Package</a>
<ul>
<li><a href="#dependencies">Dependencies</a></li>
<li><a href="#the-development-process-makefiles">The Development
Process: Makefiles</a>
<ul>
<li><a href="#details">Details</a>
<ul>
<li><a href="#conda-and-anaconda-project">Conda and Anaconda
Project</a></li>
</ul></li>
<li><a href="#things-that-did-not-work">Things that Did Not
Work</a></li>
</ul></li>
<li><a href="#pdm">PDM</a>
<ul>
<li><a href="#issues">Issues</a></li>
</ul></li>
<li><a href="#poetry">Poetry</a></li>
<li><a href="#soft-dependencies">Soft Dependencies</a></li>
<li><a href="#issues">Issues:</a></li>
<li><a href="#references-2">References</a></li>
</ul></li>
<li><a href="#testing-1">Testing</a>
<ul>
<li><a href="#issues-1">Issues:</a></li>
</ul></li>
<li><a href="#github">GitHub</a></li>
<li><a href="#issues-2">Issues:</a>
<ul>
<li><a href="#pyfftw">pyFFTW</a></li>
<li><a href="#sleep">Sleep</a></li>
</ul></li>
<li><a href="#cocalc">[CoCalc][]</a>
<ul>
<li><a href="#implementation-details">Implementation Details</a></li>
</ul></li>
<li><a href="#reference">Reference</a>
<ul>
<li><a href="#conda-issues">Conda Issues</a></li>
<li><a href="#black-issues">Black Issues</a></li>
<li><a href="#pdm-issues">PDM Issues</a></li>
<li><a href="#poetry-issues">Poetry Issues</a></li>
<li><a href="#pipx-issues">PipX Issues</a></li>
<li><a href="#condax-issues">CondaX Issues</a></li>
<li><a href="#cocalc-issues">CoCalc Issues</a></li>
</ul></li>
<li><a href="#odds-and-ends">Odds and Ends</a></li>
<li><a href="#references-3">References</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
</details>
<h1 id="to-do">To Do</h1>
<ul>
<li>Consider a two-branch model so that one can easily update to the
latest development branch or the latest default branch. Maybe default
should be the development branch and we should have a release branch?
(Thinking about testing and badges… currently I have a branch for each
version, but this means I need to specify the latest one each
time.)</li>
<li>Fix bases to properly use GPU (sundered values etc.).</li>
</ul>
<h1 id="tldr">TL;DR</h1>
<p>Getting started should be as easy as:</p>
<ol type="1">
<li>Cloning the project (or initializing with <a
href="https://gitlab.com/forbes-group/cookiecutters">our cookiecutter
templates</a>).</li>
<li>(Optional) <code>make tools</code> and adding the appropriate folder
to your path. <em>(This is not implemented yet: currently you should
install your tools with your OS package managers, <a
href="https://pypa.github.io/pipx/">pipx</a> etc.)</em></li>
<li><code>make shell</code>: This launches a shell which should have
everything installed so you can just start working.</li>
<li><code>make doc-server</code>: Build and launch the documentation
server.</li>
<li><code>make realclean</code>: Cleanup everything as much as
possible.</li>
</ol>
<p>To support this, our project structure uses the following files:</p>
<ul>
<li><code>Makefile</code>: We use <a
href="https://www.gnu.org/software/make/manual/make.html">GNU make</a>
to collect “wisdom” about how to build, install, activate, etc. our
development environments. In an effort to be platform and tool agnostic,
these may get complicated, but they will contain lots of useful
information. Useful commands include:
<ul>
<li><code>make shell</code>: Starts a shell with everything needed for
work.</li>
<li><code>make realclean</code>: Cleans up as much as possible. As close
as possible to a fresh checkout.</li>
</ul></li>
<li><a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata"><code>pyproject.toml</code></a>:
Most of our work is based on Python, and this is <a
href="https://packaging.python.org/en/latest/guides/writing-pyproject-toml/">the
standard</a> way to specify dependencies and configure python. Various
(<a
href="https://chriswarrick.com/blog/2023/01/15/how-to-improve-python-packaging/">too
many!</a>) tool exist for helping update this. Currently we recommend <a
href="https://pdm.fming.dev/latest/">PDM</a> (was previously <a
href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>,
but they do not <a
href="https://github.com/python-poetry/poetry/issues/3332">support this
standard</a>.) We follow <a
href="https://scikit-hep.org/developer/packaging#extras-lowmedium-priority">Scikit-HEP’s
recommendation</a> that the extras <code>test</code>, <code>docs</code>,
and <code>dev</code> be defined here, though the latter may be managed
by a tool like <a href="https://pdm.fming.dev/latest/">PDM</a>.</li>
<li><code>environment.yaml</code>: Many of our projects require
something for which installing with <a href="https://docs.conda.io"
title="Conda">conda</a> is easiest. (<a
href="https://github.com/pyFFTW/pyFFTW">PyFFTW</a> and <a
href="https://cupy.dev">CuPy</a> are obvious examples, but even <a
href="https://numpy.org/install/#numpy-packages--accelerated-linear-algebra-libraries">NumPy
with MKL</a> optimizations is included.) In principle, with <a
href="https://anaconda-project.readthedocs.io/en/latest/">Anaconda
Project</a>, an equivalent <code>anaconda-project.yaml</code> file can
replace the <code>Makefile</code> and <a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata"><code>pyproject.toml</code></a>,
but this does not work for us (see below).</li>
</ul>
<h1 id="tools">Tools</h1>
<p>I generally make sure I have the following tools installed globally.
I do this with <a href="https://pypa.github.io/pipx/">pipx</a> using a
different account (<code>admin</code>) on my computer so I don’t
accidentally muck these up. I also keep my <code>base</code> <a
href="https://docs.conda.io" title="Conda">Conda</a> environment in this
account for the same reason. For complete details see <a
href="https://swan.physics.wsu.edu/forbes/draft/mac-os-x/">mac-os-x</a>.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On Mac OS X using MacPorts:</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> conda <span class="co"># My alias to login as `conda`</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install <span class="at">-n</span> base pipx</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">port</span> install git gmake pandoc myrepos graphviz</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">port</span> install python37 python38 python39 python310 python311</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> app <span class="kw">in</span> cookiecutter pdm poetry yapf black nox    <span class="dt">\</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>           nbdime jupytext nbstripout                <span class="dt">\</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>           poetry2conda conda-lock conda-pack condax <span class="dt">\</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>           sphobjinv rst-to-myst twine               <span class="dt">\ </span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>           <span class="ex">mercurial</span> mmf_setup snakeviz              <span class="dt">\</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>           grip<span class="kw">;</span> <span class="cf">do</span> <span class="ex">pipx</span> install <span class="va">${app}</span><span class="kw">;</span> <span class="cf">done</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="ex">pipx</span> inject nox nox-poetry poetry </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="ex">pipx</span> inject pdm pdm-shell</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="ex">pipx</span> inject mercurial hg-git hg-evolve</span></code></pre></div>
<p>You may not need all of these.</p>
<p>In addition, you will likely need to install compilers and
development tools, and <a href="https://www.tug.org/texlive/">TeX
Live</a> for making publication-quality plots.</p>
<p>In the future, the tools (except for <a
href="https://www.tug.org/texlive/">TeX Live</a> and compilers) needed
for the project will be able to be installed locally with
<code>make tools</code>.</p>
<p>In <a href="https://gitlab.com/forbes-group/cookiecutters">our
cookiecutter templates</a>, we are experimenting with ways of installing
these locally with the Makefile through a command like
<code>make tools</code>, or as needed. This is still a bit of a work in
progress.</p>
<h1 id="python-dependencies">Python Dependencies</h1>
<p>The pure python dependencies should be specified in <a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata"><code>pyproject.toml</code></a>.
If you are developing a package to publish on <a href="https://pypi.org"
title="PyPI: The Python Package Index">PyPI</a>, then this should
contain <strong>all</strong> dependencies.</p>
<h2 id="pdm"><a href="https://pdm.fming.dev/latest/">PDM</a></h2>
<p>We currently manage this file with <a
href="https://pdm.fming.dev/latest/">PDM</a>, e.g.:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> shell</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> add uncertainties</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> add <span class="at">-G</span> test pytest-cov</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> add <span class="at">-G</span> docs sphinx</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> add <span class="at">--dev</span> ipython</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div>
<p>In addition to the development dependencies specified in
<code>[tool.pdm.dev-dependencies]</code>, one should generally include
the <code>test</code> and <code>docs</code> extras. For our work, we
also often use the following:</p>
<ul>
<li><p><code>perf</code>: Tools for high-performance computing that
might be difficult to install, so we make them optional. <a
href="https://github.com/pyFFTW/pyFFTW">PyFFTW</a>, <a
href="https://numba.pydata.org">Numba</a>, and <a
href="https://mathema.tician.de/software/pycuda/">PyCUDA</a> are good
examples. Note that, from a development perspective, these are often
provided in the <a href="https://docs.conda.io" title="Conda">Conda</a>
environment, but are needed here if you want your package to be <a
href="https://pip.pypa.io/en/stable/">pip</a>-installable from <a
href="https://pypi.org" title="PyPI: The Python Package Index">PyPI</a>.
Some extra effort is needed to make sure that the versions specified in
<code>environment.yaml</code> are consistent with the versions here.</p>
<p>Now that I know about <a
href="https://hynek.me/articles/python-recursive-optional-dependencies/">recursive
optional dependencies in Python</a>, I am considering splitting these
into <code>gpu</code>, <code>pyfftw</code>, <code>numba</code>,
etc.</p></li>
<li><p><code>full</code>: All functional dependencies. I.e. everything
except <code>docs</code> and <code>test</code>. Note: if you include
packages here or in <code>perf</code>, you should be sure to make sure
that these do not break imports. For example (see
<code>src/mmfutils/performance/fft.py</code> for example):</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pyfftw</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">ImportError</span>:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    warnings.warn(<span class="st">&quot;Could not import pyfftw... falling back to numpy&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    pyfftw <span class="op">=</span> <span class="va">None</span></span></code></pre></div>
<p>An exception is if there is a particular sub-module that obviously
depends on this feature, then it is probably okay for that to just fail
on import.</p></li>
<li><p><code>all</code>: Everything including <code>docs</code> and
<code>test</code>. Perhaps this should always be spelled</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">all</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mmfutils[full,test,docs]&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre></div>
<p>with <code>mmfutils</code> replaced by the package name? (I don’t
think <code>".[full,test.docs]"</code> is supported.)</p></li>
</ul>
<p>After you have finished editing <a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata"><code>pyproject.toml</code></a>,
you should check the dependencies with your tool of choice, for
example:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> shell</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> update</span></code></pre></div>
<h1 id="conda-dependencies"><a href="https://docs.conda.io"
title="Conda">Conda</a> Dependencies</h1>
<p>The development environment will generally be created with <a
href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">micromamba</a>
as specified in the <code>environment.yaml</code> file. My current
simplified approach is as follows:</p>
<ol type="1">
<li><p>Optionally use an <code>environment.yaml</code> file managed with
<a
href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">micromamba</a>
to setup the base environment.</p></li>
<li><p>Use <code>pip</code> (managed by another tool like <a
href="https://pdm.fming.dev/latest/">PDM</a> or <a
href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>)
to provision pure python dependencies.</p></li>
<li><p>Control this with a <code>Makefile</code> that supports the
following targets:</p>
<ul>
<li><strong><code>make tools</code></strong>:
<ul>
<li>Install necessary tools into <code>.local/bin/</code>.</li>
</ul></li>
<li><strong><code>make init</code></strong>:
<ul>
<li>Initializes the environment.</li>
<li>Installs the Jupyter kernel for the environment.</li>
</ul></li>
<li><strong><code>make shell</code></strong>:
<ul>
<li>Spawns a shell with an initialized environment (similar to
<code>poetry shell</code>).</li>
</ul></li>
<li><strong><code>make realclean</code></strong>:
<ul>
<li>Remove the kernel, all environments, cache files etc.</li>
</ul></li>
</ul></li>
</ol>
<h2 id="makefile">Makefile</h2>
<p>If we use some form of <a href="https://docs.conda.io"
title="Conda">Conda</a>, <a
href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">micromamba</a>
or [anaconda-project][], then we need the following commands, which we
provide through appropriately defined variables. For all of these, the
<code>conda</code> command will actually be called with
<code>$(CONDA_EXE)</code> which can be set to <code>mamba</code> if
desired (but this does not work with <code>micromamba</code> for all
commands).</p>
<ul>
<li><code>CREATE_ENV</code>: Create the virtual/conda environment.
<ul>
<li><code>conda env create -f environment.yaml -p &lt;env_path&gt;</code></li>
<li><code>micromamba create -f environment.yaml -p &lt;env_path&gt;</code></li>
<li><code>anaconda-project prepare [--spec &lt;env_spec&gt;]</code></li>
<li><code>pdm ???</code></li>
<li><code>poetry ???</code></li>
</ul></li>
<li><code>UPDATE_ENV</code>: Update the virtual/conda environment. This
should be fast if the environment is already up to date.
<ul>
<li><code>conda env update -f environment.yaml -p &lt;env_path&gt;</code></li>
<li><code>micromamba update -f environment.yaml -p &lt;env_path&gt;</code></li>
<li><code>anaconda-project prepare</code> (Not really needed - this is
done before all commands).</li>
<li><code>pdm ???</code></li>
<li><code>poetry ???</code></li>
</ul></li>
<li><code>ACTIVATE_ENV</code>: Activate the virtual environment in the
current shell. We generally do not want to do this, but will use this in
the <code>make shell</code> target.
<ul>
<li><code>conda activate &lt;env&gt;</code></li>
<li><code>micromamba activate &lt;env&gt;</code></li>
<li><code>source anaconda-project activate &lt;env&gt;</code>???</li>
<li><code>pdm ???</code></li>
<li><code>poetry ???</code></li>
</ul></li>
<li><code>RUN</code>: Run a command in the environment.
<ul>
<li><code>conda run -p &lt;env&gt;</code></li>
<li><code>micromamba run -p &lt;env&gt;</code></li>
<li><code>CONDA_EXE=$(CONDA_EXE) anaconda-project run</code></li>
<li><code>pdm run</code></li>
<li><code>poetry run</code></li>
</ul></li>
</ul>
<h1 id="managing-multiple-versions-of-python">Managing Multiple Versions
of Python</h1>
<p>Supporting multiple versions of python is painful – especially
ensuring that tests pass. Consider dropping support for <a
href="https://devguide.python.org/versions/">versions past their
end-of-life</a> if at all possible. The general strategy is to add
conditional <code>python_version</code> entries as needed keep
everything working with previous python versions. For example, to keep
scipy working, one might include the following:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="dt">scipy</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;scipy &gt;= 1.7.3; python_version &lt; &#39;3.8&#39;&quot;</span><span class="op">,</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;scipy &gt;= 1.10.1; python_version &gt;= &#39;3.8&#39; and python_version &lt; &#39;3.9&#39;&quot;</span><span class="op">,</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;scipy &gt;= 1.13.1; python_version &gt;= &#39;3.9&#39; and python_version &lt; &#39;3.10&#39;&quot;</span><span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;scipy &gt;= 1.14.1; python_version &gt;= &#39;3.10&#39;&quot;</span><span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre></div>
<p>As far as I can tell, there are no tools like <a
href="https://pdm.fming.dev/latest/">PDM</a> or <a
href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
that do this automatically. This is an <a
href="https://frostming.com/en/2024/pdm-lock-strategy/#conditional-dependencies">acknowledged
limition of PDM</a> and also makes locking difficult The workaround is
to <a href="https://pdm-project.org/en/latest/usage/lock-targets/">lock
targets</a>, generating either a bunch of lock files, or merging these
into one. Thus, you might do the following:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> lock <span class="at">--python</span><span class="op">=</span><span class="st">&quot;3.9.*&quot;</span> <span class="at">--append</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> lock <span class="at">--python</span><span class="op">=</span><span class="st">&quot;3.10.*&quot;</span> <span class="at">--append</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> lock <span class="at">--python</span><span class="op">=</span><span class="st">&quot;3.11.*&quot;</span> <span class="at">--append</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> lock <span class="at">--python</span><span class="op">=</span><span class="st">&quot;3.12.*&quot;</span> <span class="at">--append</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ex">pdm</span> lock <span class="at">--python</span><span class="op">=</span><span class="st">&quot;3.13.*&quot;</span> <span class="at">--append</span></span></code></pre></div>
<p>We provide a target <code>make pdm.lock</code> that does this.</p>
<p>Instead, you must use these to deduce set of working versions. I do
this by slowly building up set of working versions in a temporary
project.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> tmp <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> tmp</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ver <span class="kw">in</span> 3.9 3.10 3.11 3.12 3.13<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span> <span class="at">-rf</span> pyproject.toml pdm.lock .pdm-python .venv</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">pdm</span> init <span class="at">--python</span> <span class="st">&quot;</span><span class="va">${ver}</span><span class="st">&quot;</span> <span class="at">-n</span>  <span class="co"># Start with the lowest version you want to support.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">pdm</span> add numba                  <span class="co"># Try adding the most difficult package. </span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">grep</span> numba pyproject.toml </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>Note</p>
<h2 id="testing">Testing</h2>
<p>To test against multiple versions, we use <a
href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">Nox</a>, which is configured in
<code>noxfile.py</code>. For this to work, we must have the desired
versions of python installed. This can be done globally (using the
<code>test</code> session), using <code>conda</code> (using the
<code>test_conda</code> session), or using <code>make envs/py3.9</code>
(I do this on my ARM Mac OS X for example).</p>
<p>Ultimately we would like these tests to run <a
href="#github">GitHub</a> and/or [GitLab][] with CI. A simple solution
is to just provision and run <a href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">Nox</a>, but this has the
disadvantage that, if any version of python fails the tests, then the
test just fails.</p>
<h3 id="github-ci">GitHub CI</h3>
<p>A natural strategy for running multiple tests is a <a
href="https://docs.github.com/en/actions/use-cases-and-examples/building-and-testing/building-and-testing-python#using-multiple-python-versions">GitHub
matrix</a>. This works, but has several limitations:</p>
<ul>
<li>Now you get a report of which individual tests fail, but I don’t
know how to incorporate this into status badges. There is a discussion
about <a
href="https://github.com/orgs/community/discussions/52616">status badges
for matrix builds</a>, but as of 2025, this seems not to be implemented.
In this discussion, the suggestion is made to use <a
href="https://docs.github.com/en/actions/sharing-automations/reusing-workflows">reusable
workflows</a> with individual badges for each workflow. We discuss this
approach below.</li>
<li>This strategy requires provisioning multiple tests. In the case of
this project, we need to install some LaTeX so that matplotlib tests
work. From a development perspective, the easiest approach is to
<code>apt-get install texlive-full</code>, but this requires multiple
independent downloads of ~6GB of data which is slow and wasteful. I
don’t have a good solution for this yet but expect there is something:
<ul>
<li>There is support for <a
href="https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/caching-dependencies-to-speed-up-workflows">GitHub
caching</a>, but you need to specify exactly what is to be cached, and
it is trivial how to <a
href="https://stackoverflow.com/questions/59269850/caching-apt-packages-in-github-actions-workflow">cache
APT packages</a>, but this discussion has some suggestions.</li>
<li>There is probably a solution if one first builds a Docker container,
then uses this as the base environment.</li>
<li>Another strategy is to minimize the provisioning. For
<code>texlive-full</code>, the following might help: <a
href="https://gist.github.com/wkrea/b91e3d14f35d741cf6b05e57dfad8faf"><code>texlive-full</code>
without all the beef</a>. We could also manually minimize the packages,
but this might be a lot of work.</li>
</ul></li>
</ul>
<p>Our current approach uses <a
href="https://docs.github.com/en/actions/sharing-automations/reusing-workflows">reusable
workflows</a>. This does not help with the caching issue but gets us
badges. This seems to require one workflow file for each version of
python, so we generate these from our Makefile.</p>
<p><a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.9.yaml"><img
src="https://img.shields.io/github/actions/workflow/status/forbes-group/mmfutils/python_3.9.yaml?label=3.9&amp;logo=GitHub"
alt="Python 3.9 test results" /></a> <a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.10.yaml"><img
src="https://img.shields.io/github/actions/workflow/status/forbes-group/mmfutils/python_3.10.yaml?label=3.10&amp;logo=GitHub"
alt="Python 3.10 test results" /></a> <a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.11.yaml"><img
src="https://img.shields.io/github/actions/workflow/status/forbes-group/mmfutils/python_3.11.yaml?label=3.11&amp;logo=GitHub"
alt="Python 3.11 test results" /></a> <a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.12.yaml"><img
src="https://img.shields.io/github/actions/workflow/status/forbes-group/mmfutils/python_3.12.yaml?label=3.12&amp;logo=GitHub"
alt="Python 3.12 test results" /></a> <a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.13.yaml"><img
src="https://img.shields.io/github/actions/workflow/status/forbes-group/mmfutils/python_3.13.yaml?label=3.13&amp;logo=GitHub"
alt="Python 3.13 test results" /></a></p>
<p><a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.9.yaml"><img
src="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.9.yaml/badge.svg"
alt="Python 3.9 test results" /></a> <a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.10.yaml"><img
src="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.10.yaml/badge.svg"
alt="Python 3.10 test results" /></a> <a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.11.yaml"><img
src="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.11.yaml/badge.svg"
alt="Python 3.11 test results" /></a> <a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.12.yaml"><img
src="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.12.yaml/badge.svg"
alt="Python 3.12 test results" /></a> <a
href="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.13.yaml"><img
src="https://github.com/forbes-group/mmfutils/actions/workflows/python_3.13.yaml/badge.svg"
alt="Python 3.13 test results" /></a></p>
<h1 id="tools-1">Tools</h1>
<p>When developing applications, one often needs a set of tools (see
following section). The question is: how should these be managed? Here
are some options:</p>
<ul>
<li>As part of the package (i.e. specified in the
<code>pyproject.toml</code>, <code>environment.yaml</code>, or
<code>anaconda-project.yaml</code> files). This is convenient and
satisfies the DRY principle, but can cause some issues if the tool
dependencies conflict with the project itself.</li>
<li><a href="https://pdm.fming.dev/latest/">PDM</a> development groups.
As of version 1.5.0, PDM supports <a
href="https://pdm.fming.dev/latest/usage/dependency/#add-development-only-dependencies">development-only
dependencies</a> that won’t appear in the package index and should not
affect the main package dependencies. (I am not sure if <a
href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
has a similar functionality.)</li>
<li>In a separate <a href="https://docs.conda.io"
title="Conda">Conda</a> environment. Unlike the previous approaches,
this allows one to install tools that require <a
href="https://docs.conda.io" title="Conda">Conda</a>. This separates the
dependencies, but provides a clean place for them –
<code>environment.tools.yaml</code>.</li>
<li>Install each tool in an isolated environment with <a
href="https://pypa.github.io/pipx/">PipX</a> (or <a
href="https://github.com/mariusvniekerk/condax">CondaX</a>, but there
are some issues, e.g. a lack of scriptable ways of locating the
packages, or specifying python versions). The current question is: where
should one specify these dependences? A nice solution from the user’s
perspective is to have separate targets in <code>Makefile</code> for
each tool. However, I think this means we need to specify the versions
in the <code>Makefile</code>, or do some parsing. It might also be a
burden maintaining. Perhaps an automatic rule could be used for
<code>$(BIN)/tool:   &lt;what_file_here?&gt;</code> which runs
<code>pipx</code> to install the tool as specified in
<code>&lt;what_file_here?&gt;</code>. (<code>requirements.txt</code>, or
maybe a section in <code>pyproject.toml</code>? Probably needs custom
parsing.)</li>
</ul>
<p>For now I am going with <code>environment.tools.yaml</code> as it
seems the simplest to maintain.</p>
<h2 id="useful-tools">Useful Tools</h2>
<ul>
<li><p><a href="https://pypa.github.io/pipx/">PipX</a>: A tool for
installing packages in independent environments.</p></li>
<li><p><a href="https://coverage.readthedocs.io/en/latest">Coverage</a>:
Normally this is installed along with PyTest, but it can be needed as a
standalone tool for <code>make clean</code> which calls
<code>coverage erase</code> to remove the coverage files. One could do
this manually, but config files can override the default location. Using
the tool itself takes care of this.</p></li>
<li><p><a href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">Nox</a>: a command-line tool that
automates testing in multiple Python environments, similar to tox, but
using a standard Python file for configuration. Nox is configured via a
<code>noxfile.py</code> file.</p></li>
<li><p><a
href="https://jupytext.readthedocs.io/en/latest/">Jupytext</a>: Converts
notebooks. More of a development tool, but often used in
<code>make sync</code>.</p></li>
<li><p><a
href="https://nbconvert.readthedocs.io/en/latest/">Nbconvert</a>:
Similar and needed by <a
href="https://jupytext.readthedocs.io/en/latest/">Jupytext</a>, but
cannot be installed in the same environment with <a
href="https://pypa.github.io/pipx/">PipX</a>.</p></li>
<li><p><a href="https://pdm.fming.dev/latest/">PDM</a>: a Python package
management tool that allows you to manage your project dependencies and
environments in a more flexible and efficient way than pip. It is built
on top of pip and provides additional features such as dependency
resolution, lock files, and build isolation. PDM is not limited to a
specific build backend; users have the freedom to choose any build
backend they prefer.</p></li>
<li><p><a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>:
Another Python package management tool that aims to provide a simple and
reliable way to manage project dependencies. Poetry uses a lock file to
ensure repeatable installs and provides features such as dependency
resolution, virtual environments, and build isolation.</p></li>
<li><p><a
href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">micromamba</a>:
A fast and small alternative to <a href="https://docs.conda.io"
title="Conda">conda</a>. It can be installed <a
href="https://mamba.readthedocs.io/en/latest/installation.html#install-script">as
follows</a>:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;</span><span class="va">${SHELL}</span><span class="st">&quot;</span> <span class="op">&lt;(</span><span class="ex">curl</span> <span class="at">-L</span> micro.mamba.pm/install.sh<span class="op">)</span><span class="kw">`</span></span></code></pre></div>
<p>This will install the executable into
<code>~/.local/bin/micromamba</code>. If you want to control this, you
must explicitly choose a download. See the results of
<code>curl -L micro.mamba.pm/install.sh</code> for an idea of how to
modify this. Currently I am using:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="va">$(</span><span class="ex">MICROMAMBA</span><span class="va">)</span><span class="ex">:</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;</span><span class="va">$(</span><span class="ex">SHELL</span><span class="va">)</span><span class="st">&quot;</span> <span class="op">&lt;(</span><span class="ex">curl</span> <span class="at">-L</span> micro.mamba.pm/install.sh <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">sed</span> <span class="st">&quot;s:~/.local/bin:</span><span class="va">$(</span><span class="fu">dir</span> <span class="va">$@)</span><span class="st">:g&quot;</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">sed</span> <span class="st">&quot;s:\[ -t 0 \]:false:g&quot;</span> <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>                       <span class="fu">sed</span> <span class="st">&#39;s:YES=&quot;yes&quot;:YES=&quot;no&quot;:g&#39;</span><span class="op">)</span></span></code></pre></div>
<p><a
href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">micromamba</a>
has some slight differences with <a href="https://docs.conda.io"
title="Conda">conda</a>, but is a very workable replacement.</p>
<ul>
<li><p>There is not <code>micromamba env</code> like
<code>conda env</code>. One should just use <code>micromamba</code>.
However, this probably means that [<code>anaconda-client</code>][] is
not supported: I have not found a way of installing an environment from
<code>anaconda.org</code> like
<code>conda env   create mforbes/work</code>, which pulls from an
environment spec hosted on Anaconda cloud.</p></li>
<li><p>It seems that if you create an environment with
<code>CONDA_SUBDIR=osx-64 micromamba</code>, then, after that
environment, it will pull from the correct subdir. This is different
from (and better than) <a href="https://docs.conda.io"
title="Conda">conda</a>, which requires also running the rather magic
<code>conda config --env --set subdir $(CONDA_SUBDIR)</code>
command.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="va">CONDA_SUBDIR</span><span class="op">=</span>osx-64 <span class="ex">micromamba</span> create <span class="at">-y</span> <span class="at">-c</span> defaults <span class="at">-p</span> osx-64/ <span class="st">&quot;python~=3.11&quot;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="va">CONDA_SUBDIR</span><span class="op">=</span>osx-arm64 <span class="ex">micromamba</span> create <span class="at">-y</span> <span class="at">-c</span> defaults <span class="at">-p</span> osx-arm64/ <span class="st">&quot;python~=3.11&quot;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">micromamba</span> install <span class="at">-c</span> defaults <span class="at">-p</span> osx-64/ numpy     <span class="co"># Pulls osx-64 version of numpy</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">micromamba</span> install <span class="at">-c</span> defaults <span class="at">-p</span> osx-arm64/ numpy  <span class="co"># Pulls osx-arm64 version of numpy</span></span></code></pre></div>
<p>In contrast, <a href="https://docs.conda.io" title="Conda">conda</a>
needs additional machinations:</p>
<pre><code># Both of these pull the WRONG osx-arm64 version of numpy
conda install -c defaults -p osx-64/ numpy
conda run -p osx-64 conda install -c defaults -p osx-64/ numpy

# This works... and we will use this to be careful.
CONDA_SUBDIR=osx-64 conda install -c defaults -p osx-64/ numpy

# Otherwise, we need conda config... which annoyingly does not accept -p...
conda run -p osx-64 conda config --env --set subdir osx-64

# Now ONLY this one works:
conda run -p osx-64 conda install -c defaults -p osx-64/ numpy</code></pre></li>
</ul></li>
<li><p><a
href="https://anaconda-project.readthedocs.io/en/latest/">Anaconda
Project</a>: A tool for managing data science projects that provides an
easy way to create, share, and reproduce data science workflows. It
allows you to specify required packages and multiple Conda environments
in an <code>anaconda-project.yaml</code> file.</p></li>
<li><p><a href="https://black.readthedocs.io/en/stable/">Black</a>: A
Python code formatter that reformats your code to make it more readable
and consistent. If you want to format Jupyter Notebooks, install with
<code>pip install   "black[jupyter]"</code>. Note: if you want to format
cells in the notebook with the you must install <code>black</code> in
the kernel, not the environment running <code>jupyter</code> (though
<code>pip   install "black[jupytyer]"</code> in that environment is a
convenient way of installing the extension). (See <a
href="https://github.com/drillan/jupyter-black/issues/26">issue
#26</a>.)</p></li>
<li><p><a
href="https://jupytext.readthedocs.io/en/latest/">Jupytext</a>: A Python
package that provides two-way conversion between Jupyter notebooks and
several other text-based formats like Markdown (we generally use
[MyST][] Markdown files).</p></li>
</ul>
<h1 id="working-environment-condapip-and-all-that">Working Environment
(Conda/Pip and all that)</h1>
<p>Our goal is to be able to use <a href="https://docs.conda.io"
title="Conda">conda</a> for packages that might require binary installs,
such as <code>pyfftw</code>, <code>pyvista</code>, <code>numpy</code>
etc., but allow <a href="https://pip.pypa.io/en/stable/">pip</a>, <a
href="https://pdm.fming.dev/latest/">PDM</a>, or <a
href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
to be used for pure python packages. Our strategy attempts to balance
the following desires/features/issues:</p>
<ul>
<li><p><a href="https://docs.conda.io" title="Conda">Conda</a> is the
most convenient choice for managing binary installs in a platform
independent way. Alternatives include using package managers (platform
dependent) like <code>apt</code>, <code>macports</code>, or building
from source, but this can be tricky.</p>
<p>A concrete example is <a href="https://cupy.dev">CuPy</a> which
requires very specific versions of the <a
href="https://developer.nvidia.com/cuda-toolkit"
title="CUDA Toolkit">CUDA</a> toolkit, so generically upgrading to the
latest might not be compatible. <a href="https://docs.conda.io"
title="Conda">Conda</a> allows one to resolve all of these issues
<strong>if</strong> a package has been built.</p></li>
<li><p><a href="https://docs.conda.io" title="Conda">Conda</a> can be
very slow/memory intensive, especially if searching
<code>conda-forge</code>. <a
href="https://github.com/mamba-org/mamba">Mamba</a> can sometimes help,
but is not always the solution. <a
href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">Micromamba</a>
seems to work very nicely.</p>
<p>A concrete example is <a href="https://cocalc.com">CoCalc</a> where
even <code>conda search</code> can exhaust the memory since the default
<a href="https://docs.conda.io" title="Conda">Conda</a> installation has
a huge list of channels. Reducing the number of channels solved this
problem. <a href="https://github.com/mamba-org/mamba">Mamba</a> works
too, but <a
href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">Micromamba</a>
is much better.</p>
<details>
<summary>
<p>Sample CoCalc Session</p>
</summary>
<p>Consider the following <code>environment.tools.yaml</code> file:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> tools</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">channels</span><span class="kw">:</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> defaults</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> python~=3.11</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> pip</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">pip</span><span class="kw">:</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> pipx</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> black</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> jupytext</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda clean <span class="at">--all</span> <span class="at">--yes</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> time anaconda2022 <span class="kw">&amp;&amp;</span> <span class="ex">/usr/bin/time</span> <span class="at">-v</span> conda env create <span class="at">-f</span> environment.tools.yaml <span class="at">-p</span> envs/tools</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Starting</span> Anaconda Python environment</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Run</span> <span class="st">&#39;exit-anaconda&#39;</span> to return to the standard terminal</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ex">real</span> 0m1.050s</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ex">user</span> 0m0.720s</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ex">sys</span>  0m0.246s</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Collecting</span> package metadata <span class="er">(</span><span class="ex">repodata.json</span><span class="kw">)</span><span class="bu">:</span> <span class="at">-</span> Command terminated by signal 9</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Command</span> being timed: <span class="st">&quot;conda env create -f environment.tools.yaml -p envs/tools&quot;</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">User</span> time <span class="er">(</span><span class="ex">seconds</span><span class="kw">)</span><span class="bu">:</span> 44.69</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">System</span> time <span class="er">(</span><span class="ex">seconds</span><span class="kw">)</span><span class="bu">:</span> 5.43</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Percent</span> of CPU this job got: 93%</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Elapsed</span> <span class="er">(</span><span class="fu">wall</span> clock<span class="kw">)</span> <span class="bu">time</span> <span class="er">(</span><span class="ex">h:mm:ss</span> or m:ss<span class="kw">)</span><span class="bu">:</span> 0:53.86</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Maximum</span> resident set size <span class="er">(</span><span class="ex">kbytes</span><span class="kw">)</span><span class="bu">:</span> 1905264 <span class="er">(</span><span class="ex">1.8GB</span><span class="kw">)</span> </span></code></pre></div>
<p>Crashes after running out of memory (~ 2GB).</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda clean <span class="at">--all</span> <span class="at">--yes</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> time anaconda2022 <span class="kw">&amp;&amp;</span> <span class="ex">/usr/bin/time</span> <span class="at">-v</span> mamba env create <span class="at">-f</span> environment.tools.yaml <span class="at">-p</span> envs/tools</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Command</span> being timed: <span class="st">&quot;mamba env create -f environment.tools.yaml -p envs/tools&quot;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">User</span> time <span class="er">(</span><span class="ex">seconds</span><span class="kw">)</span><span class="bu">:</span> 35.37</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Elapsed</span> <span class="er">(</span><span class="fu">wall</span> clock<span class="kw">)</span> <span class="bu">time</span> <span class="er">(</span><span class="ex">h:mm:ss</span> or m:ss<span class="kw">)</span><span class="bu">:</span> 0:57.77</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Maximum</span> resident set size <span class="er">(</span><span class="ex">kbytes</span><span class="kw">)</span><span class="bu">:</span> 515596 <span class="er">(</span><span class="ex">504MB</span><span class="kw">)</span></span></code></pre></div>
<p>Uses 28% of 2GB.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> rm <span class="at">-rf</span> envs</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> micromamba clean <span class="at">--all</span> <span class="at">--yes</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> /usr/bin/time <span class="at">-v</span> micromamba create <span class="at">-y</span> <span class="at">-f</span> environment.tools.yaml <span class="at">-p</span> envs/tools</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Command</span> being timed: <span class="st">&quot;micromamba create -y -f environment.tools.yaml -p envs/tools&quot;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">User</span> time <span class="er">(</span><span class="ex">seconds</span><span class="kw">)</span><span class="bu">:</span> 10.49</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">System</span> time <span class="er">(</span><span class="ex">seconds</span><span class="kw">)</span><span class="bu">:</span> 2.43</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Percent</span> of CPU this job got: 59%</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Elapsed</span> <span class="er">(</span><span class="fu">wall</span> clock<span class="kw">)</span> <span class="bu">time</span> <span class="er">(</span><span class="ex">h:mm:ss</span> or m:ss<span class="kw">)</span><span class="bu">:</span> 0:21.58</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Maximum</span> resident set size <span class="er">(</span><span class="ex">kbytes</span><span class="kw">)</span><span class="bu">:</span> 66076 <span class="er">(</span><span class="ex">65MB</span><span class="kw">)</span></span></code></pre></div>
<p>This demonstrates that <code>micromamba</code> is a reasonable
solution. Even if we use <code>conda-forge</code> (though this is about
twice as slow and uses thrice as much memory):</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> rm <span class="at">-rf</span> envs</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> micromamba clean <span class="at">--all</span> <span class="at">--yes</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> /usr/bin/time <span class="at">-v</span> micromamba create <span class="at">-y</span> <span class="at">-f</span> environment.tools.yaml <span class="at">-p</span> envs/tools</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Command</span> being timed: <span class="st">&quot;micromamba create -y -f environment.tools.yaml -p envs/tools&quot;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">User</span> time <span class="er">(</span><span class="ex">seconds</span><span class="kw">)</span><span class="bu">:</span> 21.59</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">System</span> time <span class="er">(</span><span class="ex">seconds</span><span class="kw">)</span><span class="bu">:</span> 3.75</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Percent</span> of CPU this job got: 54%</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Elapsed</span> <span class="er">(</span><span class="fu">wall</span> clock<span class="kw">)</span> <span class="bu">time</span> <span class="er">(</span><span class="ex">h:mm:ss</span> or m:ss<span class="kw">)</span><span class="bu">:</span> 0:46.38</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Maximum</span> resident set size <span class="er">(</span><span class="ex">kbytes</span><span class="kw">)</span><span class="bu">:</span> 207756 <span class="er">(</span><span class="ex">203MB</span><span class="kw">)</span></span></code></pre></div>
</details></li>
<li><p><a href="https://www.anaconda.cloud">Anaconda Cloud</a> is a very
convenient way of distributing environments:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install anaconda-client</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create mforbes/work</span></code></pre></div>
<p>It would be ideal if this could give a fully provisioned environment
<code>work</code> with both a useful set of python libraries for
development and python-dependent utilities such as <a
href="https://black.readthedocs.io/en/stable/">black</a>, <a
href="https://github.com/cookiecutter/cookiecutter">cookiecutter</a> and
<a href="https://www.mercurial-scm.org/">mercurial</a>. I no longer know
how to do this (see below) – please let me know if you have an
idea.</p></li>
<li><p>Conflicts can be very problematic, especially for monolithic
environments. The <a href="https://www.anaconda.com">Anaconda</a>
meta-package manages, but I think it is a lot of work to maintain.</p>
<p>I used to do this with my <code>work</code> environment, but when I
switched to a new Mac with an <a href="https://www.arm.com">ARM</a>
processor, I started to run into major conflicts. It turns our that most
of these are caused by utilities like [coockiecutter][] and <a
href="https://black.readthedocs.io/en/stable/">black</a> (which required
conflicting versions of <a
href="https://click.palletsprojects.com">click</a>).</p>
<p>As a result, I now recommend separately installing utilities. In
principle, this can be done using <a
href="https://pypa.github.io/pipx/">pipx</a> and <a
href="https://github.com/mariusvniekerk/condax">condax</a>, but these
are not very flexible right now, so instead, I recommend manually doing
this.</p></li>
<li><p><a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
does a more careful job of inspecting and managing dependencies –
breaking early, but producing a more reliable build
specification.</p></li>
</ul>
<ol type="1">
<li>Allows these conda environments to be installed in a read-only
environment (i.e. as a separate <code>conda</code> user).</li>
<li>Allows us to install additional project dependencies if needed.</li>
<li></li>
</ol>
<p>This kind of works: if you activate a conda environment that you do
not have write-access to, then you can at least use
<code>python -m pip install --user</code> to install additional
packages, which will go in the directory <a
href="https://docs.python.org/3/library/site.html#site.USER_BASE"><code>site.USER_BASE</code></a>
which can be customized with the <a
href="https://docs.python.org/3/using/cmdline.html#envvar-PYTHONUSERBASE"><code>PYTHONUSERBASE</code></a>
environment variable. Unfortunately, this approach does not allow you to
install additional packages with <a href="https://docs.conda.io"
title="Conda">conda</a>.</p>
<h2 id="option-1-recommendation-as-of-march-2023">Option 1
(Recommendation as of March 2023)</h2>
<ol type="1">
<li><p>Install [Miniconda][] on your system, preferably as a separate
<code>conda</code> account and user. E.g., on my Mac:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install miniconda as conda user</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> conda</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> Miniconda3-latest-MacOSX-arm64.sh <span class="at">-ubp</span> /data/apps/conda</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Update base environment</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install <span class="at">-n</span> base anaconda-client</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> update <span class="at">-n</span> base <span class="at">--all</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env update mforbes/base</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate base</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Install standalone packages from environment files</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create mforbes/hg</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> /data/apps/conda/envs/hg/bin/hg /usr/local/bin/</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Cookiecutter from source:</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="va">PIPX_BIN_DIR</span><span class="op">=</span>/usr/local/bin</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="ex">pipx</span> install git+https://github.com/cookiecutter/cookiecutter.git@2.0.2#cookiecutter</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="ex">pipx</span> install black</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Poetry recommended install</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /data/apps/</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-sSL</span> https://install.python-poetry.org <span class="kw">|</span> <span class="va">POETRY_HOME</span><span class="op">=</span>/data/apps/poetry/ <span class="ex">python3</span> <span class="at">-</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> /data/apps/poetry/bin/poetry /usr/local/bin/</span></code></pre></div>
<p>Notes:</p>
<ul>
<li><p>I include a <code>conda</code> alias in my
<code>~/.ssh/config</code> to log me in. It looks like this:</p>
<pre><code># ~/.ssh/config
...
Host conda
  Hostname localhost
  ForwardAgent yes
  User conda</code></pre></li>
<li><p>On newer versions of Mac OS X, you need to <a
href="https://stackoverflow.com/questions/58396821">jump through some
hoops</a> to make a new root folder like <code>/data</code> (called a
“firm link”).</p></li>
</ul></li>
</ol>
<p>The recommended approach is to use <a
href="https://anaconda-project.readthedocs.io/en/latest/">Anaconda
Project</a> to specify an environment in an
<code>anaconda-project.yaml</code> file. This allows you to specify the
<a href="https://docs.conda.io" title="Conda">conda</a> dependencies,
then customize the remaining installs with <a
href="https://pip.pypa.io/en/stable/">pip</a>. Here is a minimal
example:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># anaconda-project.yaml</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> myenv</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">variables</span><span class="kw">:</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">CONDA_EXE</span><span class="kw">:</span><span class="at"> mamba</span><span class="co">   # If you want to use mamba</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># This may be called `packages:` but then plain conda will fail.</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> python=3.9</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> numpy</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> pip</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">pip</span><span class="kw">:</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> uncertainties</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="fu">env_specs</span><span class="kw">:</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">myenv</span><span class="kw">:</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">channels</span><span class="kw">:</span><span class="at"> </span><span class="kw">[]</span></span></code></pre></div>
<p>This will create a local environment in <code>envs/myenv</code> (as
specified in the <code>env_specs</code> section - you can have many)
with <a href="https://docs.conda.io" title="Conda">conda</a>
provisioning <code>python</code> and <code>numpy</code> while <a
href="https://pip.pypa.io/en/stable/">pip</a> provisions
<code>uncertainties</code>. Note: you can generate a more complete
<code>anaconda-project.yml</code> file by running
<code>anaconda-project init</code>. If you use
<code>dependencies:</code> rather than <code>packages:</code> as in this
example, then you can also use <a href="https://docs.conda.io"
title="Conda">conda</a> directly</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create <span class="at">-f</span> anaconda-project.yaml</span></code></pre></div>
<p>which will create an environment <code>myenv</code> (as specified by
the <code>name</code> - <a href="https://docs.conda.io"
title="Conda">conda</a> will currently ignore the
<code>env_specs</code>). I use this on <a
href="https://readthedocs.org">Read the Docs</a> for example.</p>
<h2 id="option-2-experimental">Option 2 (experimental)</h2>
<p>If you want to use <a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
instead of <a href="https://pip.pypa.io/en/stable/">pip</a>, then I
recommend adding a command that runs poetry after the environment is
created. In this case, you should really manage as many dependencies
with <a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
as possible, using <a
href="https://anaconda-project.readthedocs.io/en/latest/">anaconda
project</a> for only the things where you really need <a
href="https://docs.conda.io" title="Conda">conda</a>.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># anaconda-project.yaml</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> myenv</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">commands</span><span class="kw">:</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">init</span><span class="kw">:</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">    unix</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>      poetry install</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>      #python3 -m ipykernel install --user --name &quot;myenv&quot; --display-name &quot;Python 3 (myenv)&quot;</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>      #jupyter nbextensions_configurator enable --user</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env_spec</span><span class="kw">:</span><span class="at"> myenv</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">shell</span><span class="kw">:</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">unix</span><span class="kw">:</span><span class="at"> bash --init-file .init-file.bash</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env_spec</span><span class="kw">:</span><span class="at"> myenv</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="fu">dependencies</span><span class="kw">:</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> python=3.9</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> poetry</span><span class="co">   # Not the recommended way of installing poetry</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> numpy</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> pip</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="fu">env_specs</span><span class="kw">:</span></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">myenv</span><span class="kw">:</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">channels</span><span class="kw">:</span><span class="at"> </span><span class="kw">[]</span></span></code></pre></div>
<p>Here we provide an <code>anaconda-project run init</code> function
that will first provision the <a href="https://docs.conda.io"
title="Conda">conda</a> environment in <code>envs/myenv</code>, then run
<a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>.
You might also use the <code>init</code> function to install a
[Jupyter][] kernel, or perform other setup functions.</p>
<p>We also include an <code>anaconda-project run shell</code> command
which behaves like <code>poetry shell</code>, first activating the <a
href="https://docs.conda.io" title="Conda">conda</a> environment, then
spawning a shell with a local init file where you can specify any
additional build features. For example, here we explicitly use <a
href="https://docs.conda.io" title="Conda">conda</a> to activate the
environment, so we get the name in the prompt:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .init-file.bash</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PS1</span><span class="op">=</span><span class="st">&quot;\h:\W \u</span><span class="dt">\$</span><span class="st"> &quot;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> <span class="va">$(</span><span class="ex">conda</span> info <span class="at">--base</span><span class="va">)</span>/etc/profile.d/conda.sh</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Assume that this is set by running anaconda-project run shell</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="va">CONDA_ENV</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${CONDA_PREFIX}</span><span class="st">&quot;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> deactivate</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate                 <span class="co"># Actvate the base environment</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate <span class="st">&quot;</span><span class="va">${CONDA_ENV}</span><span class="st">&quot;</span>  <span class="co"># Now activate the previously set environment</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="bu">alias</span> ap=<span class="st">&quot;anaconda-project&quot;</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="bu">alias</span> apr=<span class="st">&quot;anaconda-project run&quot;</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="va">_exclude_array</span><span class="op">=</span><span class="va">(</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    -name <span class="st">&quot;.hg&quot;</span> -or</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    -name <span class="st">&quot;.git&quot;</span> -or</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    -name <span class="st">&#39;.eggs&#39;</span> -or</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>    -name <span class="st">&#39;.ipynb_checkpoints&#39;</span> -or</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>    -name <span class="st">&#39;envs&#39;</span> -or </span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    -name <span class="st">&quot;*.sage-*&quot;</span> -or</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>    -name <span class="st">&quot;_build&quot;</span> -or</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    -name <span class="st">&quot;build&quot;</span> -or</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    -name <span class="st">&quot;__pycache__&quot;</span></span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a><span class="va">)</span></span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Finding stuff</span></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> finda</span> <span class="kw">{</span></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">find</span> . <span class="dt">\(</span> <span class="st">&quot;</span><span class="va">${_exclude_array</span><span class="op">[@]</span><span class="va">}</span><span class="st">&quot;</span> <span class="dt">\)</span> <span class="at">-prune</span> <span class="at">-or</span> <span class="at">-type</span> f <span class="dt">\</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>         <span class="at">-print0</span> <span class="kw">|</span> <span class="fu">xargs</span> <span class="at">-0</span> grep <span class="at">-H</span> <span class="st">&quot;</span><span class="va">${*</span><span class="op">:</span><span class="dv">1</span><span class="va">}</span><span class="st">&quot;</span></span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> findf</span> <span class="kw">{</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>    <span class="va">include_array</span><span class="op">=</span><span class="va">(</span> -name <span class="st">&quot;*.</span><span class="va">$1</span><span class="st">&quot;</span> <span class="va">)</span></span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">find</span> . <span class="dt">\(</span> <span class="st">&quot;</span><span class="va">${_exclude_array</span><span class="op">[@]</span><span class="va">}</span><span class="st">&quot;</span> <span class="dt">\)</span> <span class="at">-prune</span> <span class="at">-or</span> <span class="dt">\(</span> <span class="st">&quot;</span><span class="va">${include_array</span><span class="op">[@]</span><span class="va">}</span><span class="st">&quot;</span> <span class="dt">\)</span> <span class="dt">\</span></span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>         <span class="at">-print0</span> <span class="kw">|</span> <span class="fu">xargs</span> <span class="at">-0</span> grep <span class="at">-H</span> <span class="st">&quot;</span><span class="va">${*</span><span class="op">:</span><span class="dv">2</span><span class="va">}</span><span class="st">&quot;</span></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="kw">}</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> findpy</span> <span class="kw">{</span> <span class="ex">findf</span> py <span class="st">&quot;</span><span class="va">${*}</span><span class="st">&quot;</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> findipy</span> <span class="kw">{</span> <span class="ex">findf</span> ipynb <span class="st">&quot;</span><span class="va">${*}</span><span class="st">&quot;</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> findjs</span> <span class="kw">{</span> <span class="ex">findf</span> js <span class="st">&quot;</span><span class="va">${*}</span><span class="st">&quot;</span><span class="kw">;</span> <span class="kw">}</span></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span><span class="fu"> findcss</span> <span class="kw">{</span> <span class="ex">findf</span> css <span class="st">&quot;</span><span class="va">${*}</span><span class="st">&quot;</span><span class="kw">;</span> <span class="kw">}</span></span></code></pre></div>
<p>We also define convenient aliases and functions.</p>
<h3 id="caveats">Caveats</h3>
<ul>
<li><p>This will no longer work out-of-the-box on <a
href="https://readthedocs.org">Read the Docs</a>. Instead, you will need
to provision the other dependencies in your <a
href="https://www.sphinx-doc.org/">Sphinx</a> <code>conda.py</code>
file. For example:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># conf.py</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>on_rtd <span class="op">=</span> os.environ.get(<span class="st">&quot;READTHEDOCS&quot;</span>) <span class="op">==</span> <span class="st">&quot;True&quot;</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>...</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Allows us to perform initialization before building the docs.</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> my_init():</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Run `anaconda-project run init`, or the equivalent if on RtD.</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="co">    We must customize this for RtD because we trick RTD into installing everything from</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="co">    `anaconda-project.yaml` as a conda environment.  If we then run `anaconda-project</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="co">    run init` as normal, this will create a **whole new conda environment** and install</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="co">    the kernel from there.</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> on_rtd:</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;On RTD in directory </span><span class="sc">{</span>os<span class="sc">.</span>getcwd()<span class="sc">}</span><span class="ss">!&quot;</span>)</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>        subprocess.check_call(</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;pip&quot;</span>,</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;install&quot;</span>,</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;--upgrade&quot;</span>,</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;--use-feature=in-tree-build&quot;</span>,</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;../..[docs]&quot;</span>,</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a>        subprocess.check_call(</span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>            [</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;python3&quot;</span>,</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;-m&quot;</span>,</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;ipykernel&quot;</span>,</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;install&quot;</span>,</span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;--user&quot;</span>,</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;--name&quot;</span>,</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;phys-581-2021&quot;</span>,</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;--display-name&quot;</span>,</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Python 3 (phys-581-2021)&quot;</span>,</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&quot;Not On RTD!  Assuming you have run anaconda-project run init.&quot;</span>)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Don&#39;t reinstall everything each time or this can get really slow.</span></span>
<span id="cb25-44"><a href="#cb25-44" aria-hidden="true" tabindex="-1"></a>        <span class="co"># subprocess.check_call([&quot;anaconda-project&quot;, &quot;run&quot;, &quot;init&quot;])</span></span>
<span id="cb25-45"><a href="#cb25-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> setup(app):</span>
<span id="cb25-47"><a href="#cb25-47" aria-hidden="true" tabindex="-1"></a>    my_init()</span></code></pre></div></li>
</ul>
<h2 id="option-3-old-recommendation">Option 3 (old recommendation)</h2>
<p>For working on a specific project, we recommend doing this in the
project root folder as follows. In this example, we will clone the
<code>work</code> environment:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> myproject</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-p</span> ./.conda/envs/myproject <span class="at">--clone</span> work   <span class="co"># Took 1.5m on my Mac OS X laptop</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install <span class="at">-p</span> ./.conda/envs/myproject ipykernel     <span class="co"># So jupyter notebooks will find this</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate ./.conda/envs/myproject</span></code></pre></div>
<p>This gives the following:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">.../.conda</span><span class="kw">)</span> <span class="ex">$</span> poetry env info</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Virtualenv</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Python:</span>         3.9.4</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Implementation:</span> CPython</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Path:</span>           /Users/mforbes/current/research/skeleton/.conda</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Valid:</span>          True</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">.../.conda</span><span class="kw">)</span> <span class="ex">$</span> poetry shell</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Virtual</span> environment already activated: /Users/mforbes/current/research/skeleton/.conda</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> du <span class="at">-sh</span> ./.conda</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="ex">3.0G</span>    ./.conda</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> du <span class="at">-sh</span> /data/apps/conda/envs/work ./.conda</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="ex">3.0G</span>    /data/apps/conda/envs/work</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="ex">565M</span>    ./.conda</span></code></pre></div>
<p>Although <code>.conda/</code> looks like it takes 3GB, we see from
the second command that it only takes about 0.5GB indicating that there
is significant use of hard-links to reduce disk space.</p>
<p><strong>To Do:</strong> It would be nice to have a better way of
activating this, or recording it so that just running
<code>poetry shell</code> would work without having to explicitly
activate the environment. We could code something into the <a
href="Makefile"><code>Makefile</code></a>.</p>
<h2 id="option-3-incomplete">Option 3 (incomplete)</h2>
<p>If you do not need to install any additional packages with <a
href="https://docs.conda.io" title="Conda">conda</a>, and cannot afford
the disk space issues, then you can create a virtual environment <a
href="https://docs.python.org/3/library/venv.html"
title="Creation of virtual environments">venv</a>. I recommend managing
this with <a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="op">&lt;</span>project<span class="op">&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate work</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> venv <span class="at">--system-site-packages</span> .venv</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> env info   <span class="co"># Should find .venv</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> shell</span></code></pre></div>
<p>Note: Poetry will use a virtual environment in <code>.venv</code> if
the <a
href="https://python-poetry.org/docs/configuration#virtualenvsin-project"><code>virtualenvs.in-project</code>
option</a> is <code>None</code> (default) or <code>true</code>.</p>
<p>set <code>PYTHONUSERBASE</code>:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate work</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PYTHONUSERBASE</span><span class="op">=</span>./.local</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span><span class="st">&quot;./.local/bin:</span><span class="va">$PATH</span><span class="st">&quot;</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> pip install <span class="at">--user</span> ipykernel ...</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> ipykernel install <span class="at">--user</span> <span class="at">--name</span><span class="op">=</span>skeleton <span class="co"># Goes to the wrong place...</span></span></code></pre></div>
<p>This generally works, but the kernel is not going into
<code>PYTHONUSERBASE</code>… not sure why. Need a better solution. Maybe
look into <a href="https://github.com/fperez/copip">copip</a>?</p>
<p>See also:
<code>python3 -m venv --system-site-packages .venv</code></p>
<h3 id="testing-for-option-2">Testing for Option 2</h3>
<p>We will use the <code>mmfutil[test]</code> package to test this.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="va">tmpdir</span><span class="op">=</span><span class="st">&quot;/tmp/testvenv&quot;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">10</span><span class="dt">}</span><span class="kw">;</span> <span class="cf">do</span> <span class="ex">conda</span> deactivate<span class="kw">;</span> <span class="cf">done</span>  <span class="co"># Ensure all envrionments are deactivated.</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-e</span> <span class="st">&quot;</span><span class="va">$tmpdir</span><span class="st">&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span> </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">find</span> <span class="st">&quot;</span><span class="va">$tmpdir</span><span class="st">&quot;</span> <span class="at">-type</span> d <span class="at">-exec</span> chmod u+w {} <span class="dt">\;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rm</span> <span class="at">-rf</span> <span class="st">&quot;</span><span class="va">$tmpdir</span><span class="st">&quot;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="st">&quot;</span><span class="va">$tmpdir</span><span class="st">&quot;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="st">&quot;</span><span class="va">$tmpdir</span><span class="st">&quot;</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-y</span> <span class="at">-p</span> .conda_env python=3.8 poetry matplotlib scipy  <span class="co"># Use conda for these</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> .conda_env <span class="at">-type</span> d <span class="at">-exec</span> chmod a-w {} <span class="dt">\;</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate ./.conda_env</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> init <span class="at">--name</span> testvenv <span class="at">-n</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> venv <span class="at">--system-site-packages</span> .venv</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> add mmfutils <span class="at">-E</span> test</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Cleanup </span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span> <span class="st">&quot;</span><span class="va">$tmpdir</span><span class="st">&quot;</span> <span class="at">-type</span> d <span class="at">-exec</span> chmod u+w {} <span class="dt">\;</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-rf</span> <span class="st">&quot;</span><span class="va">$tmpdir</span><span class="st">&quot;</span></span></code></pre></div>
<ul>
<li>https://github.com/python-poetry/poetry/issues/697</li>
</ul>
<p>Here is a play-by-play</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> conda activate ./.conda_env</span></code></pre></div>
<pre><code>```bash
$ poetry show -t
mmfutils 0.5.4 Useful Utilities
├── backports.tempfile *
│   └── backports.weakref * 
├── husl *
├── pathlib *
└── zope.interface &gt;=3.8.0
```</code></pre>
<ul>
<li><p>Active conda environment to get python: poetry installs
everything needed:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">10</span><span class="dt">}</span><span class="kw">;</span> <span class="cf">do</span> <span class="ex">conda</span> deactivate<span class="kw">;</span> <span class="cf">done</span>  <span class="co"># Ensure all envrionments are deactivated.</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /tmp/testvenv0</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /tmp/testvenv0</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-y</span> <span class="at">-p</span> .conda_env python=3.8 poetry</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate ./.conda_env</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> init <span class="at">--name</span> testvenv <span class="at">-n</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> config virtualenvs.in-project true <span class="at">--local</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> env use python3</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> add mmfutils</span></code></pre></div>
<div class="sourceCode" id="cb34"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry show <span class="at">-t</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mmfutils</span> 0.5.4 Useful Utilities</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> backports.tempfile <span class="pp">*</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   └── backports.weakref <span class="pp">*</span> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> husl <span class="pp">*</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> pathlib <span class="pp">*</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> zope.interface <span class="op">&gt;</span>=3.8.0</span></code></pre></div></li>
<li><p>Here we include the <code>zope.interface</code> dependency in the
conda environment: poetry ignores this because it creates an isolated
virtual environment.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">10</span><span class="dt">}</span><span class="kw">;</span> <span class="cf">do</span> <span class="ex">conda</span> deactivate<span class="kw">;</span> <span class="cf">done</span>  <span class="co"># Ensure all envrionments are deactivated.</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /tmp/testvenv1</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /tmp/testvenv1</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-y</span> <span class="at">-p</span> .conda_env python=3.8 poetry zope.interface</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate ./.conda_env</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> init <span class="at">--name</span> testvenv <span class="at">-n</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> config virtualenvs.in-project true <span class="at">--local</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> env use python3</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> add mmfutils</span></code></pre></div>
<div class="sourceCode" id="cb36"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry show <span class="at">-t</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mmfutils</span> 0.5.4 Useful Utilities</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> backports.tempfile <span class="pp">*</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   └── backports.weakref <span class="pp">*</span> </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> husl <span class="pp">*</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> pathlib <span class="pp">*</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> zope.interface <span class="op">&gt;</span>=3.8.0</span></code></pre></div></li>
<li><p>Here we include the <code>zope.interface</code> dependency in the
conda environment, and use our approach above for sharing the
<code>site-packages</code>:</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="dt">{</span><span class="dv">1</span><span class="dt">..</span><span class="dv">10</span><span class="dt">}</span><span class="kw">;</span> <span class="cf">do</span> <span class="ex">conda</span> deactivate<span class="kw">;</span> <span class="cf">done</span>  <span class="co"># Ensure all envrionments are deactivated.</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> /tmp/testvenv2</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> /tmp/testvenv2</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> create <span class="at">-y</span> <span class="at">-p</span> .conda_env python=3.8 poetry</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate ./.conda_env</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install zope.interface</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> init <span class="at">--name</span> testvenv <span class="at">-n</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> config virtualenvs.in-project true <span class="at">--local</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> venv <span class="at">--system-site-packages</span> .venv</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> add mmfutils</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry show <span class="at">-t</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="ex">mmfutils</span> 0.5.4 Useful Utilities</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> backports.tempfile <span class="pp">*</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>   └── backports.weakref <span class="pp">*</span> </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> husl <span class="pp">*</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> pathlib <span class="pp">*</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> zope.interface <span class="op">&gt;</span>=3.8.0</span></code></pre></div></li>
</ul>
<h2 id="option-3">Option 3</h2>
<p>For testing, however, one should instead try to rely on a more
isolated procedure. If your requirements can be satisfied purely by
<code>pip</code> and you want to support pure <code>pip</code>
installations, then you should test <strong>outside of the conda
environment</strong> by creating a virtual environment:</p>
<p>If you need to depend on <code>conda</code>, then you should at least
provide an <code>environment.yml</code> file.</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> deactivate    <span class="co"># Just in case</span></span></code></pre></div>
<h2 id="references">References</h2>
<p>There are several potential issues related to permissions:</p>
<ul>
<li><a href="https://github.com/conda/conda/issues/7227"><img
src="https://img.shields.io/github/issues/detail/state/conda/conda/7227"
alt="Issue" /></a> Write permission error with a shared package cache
folder.</li>
</ul>
<h2 id="reproducible-computing">Reproducible Computing</h2>
<h3 id="conda-pack">Conda-Pack</h3>
<p>If you need to reproduce a conda environment, then <a
href="https://conda.github.io/conda-pack/"
title="Command line tool for creating archives of conda environments"><code>conda-pack</code></a>
might be the right tool. This makes a copy of the environment and all of
the files that can then be archived and reinstalled elsewhere. At the
very least, <code>conda-pack</code> provides a check on the code
installed, failing if any files installed by <a
href="https://docs.conda.io" title="Conda">Conda</a> have been
overwritten or are installed twice.</p>
<h1 id="packaging">Packaging</h1>
<p>Some examples of packages we manage and their features:</p>
<ul>
<li><p><a
href="https://github.com/sphinx-contrib/zopeext">sphinxcontrib-zopeext</a>:
A pure python package that must test against an incomplete matrix of
versions of Python and Sphinx. Hosted on <a href="#github">GitHub</a>
and is thus a reasonable place to look at their versions of CI.</p>
<p><a
href="https://github.com/sphinx-contrib/zopeext/actions/workflows/tests.yaml"><img
src="https://github.com/sphinx-contrib/zopeext/actions/workflows/tests.yaml/badge.svg"
alt="zopeext Test badge" /></a> <a
href="https://pypi.org/project/sphinxcontrib-zopeext/"><img
src="https://img.shields.io/pypi/v/sphinxcontrib-zopeext?logo=python&amp;logoColor=FBE072%22"
alt="zopeext PyPI badge" /></a> <a
href="https://github.com/sphinx-contrib/zopeext/tags"><img
src="https://img.shields.io/github/v/tag/sphinx-contrib/zopeext?logo=github"
alt="zopeext gh: tag badge" /></a> <a
href="https://coveralls.io/github/sphinx-contrib/zopeext?branch=main"><img
src="https://coveralls.io/repos/github/sphinx-contrib/zopeext/badge.svg?branch=main"
alt="zopeext Coverage badge" /></a> <a
href="https://zopeext.readthedocs.io/en/latest/?badge=latest"><img
src="https://readthedocs.org/projects/zopeext/badge/?version=latest"
alt="zopeext Documentation status badge" /></a> <a
href="https://pypi.org/project/sphinxcontrib-zopeext/"><img
src="https://img.shields.io/pypi/pyversions/sphinxcontrib-zopeext?logo=python&amp;logoColor=FBE072"
alt="zopeext Python versions badge" /></a> <a
href="https://deps.dev/pypi/sphinxcontrib-zopeext"><img
src="https://api.securityscorecards.dev/projects/github.com/sphinx-contrib/zopeext/badge"
alt="zopeext open-ssf badge" /></a> <a
href="https://github.com/sphinx-contrib/zopeext/tags"><img
src="https://img.shields.io/github/v/tag/sphinx-contrib/zopeext?logo=github"
alt="zopeext gh: tag badge" /></a> <a
href="https://github.com/sphinx-contrib/zopeext/network/members"><img
src="https://img.shields.io/github/forks/sphinx-contrib/zopeext.svg?logo=github"
alt="zopeext gh: forks badge" /></a> <a
href="https://github.com/sphinx-contrib/zopeext/graphs/contributors"><img
src="https://img.shields.io/github/contributors/sphinx-contrib/zopeext.svg?logo=github"
alt="zopeext gh: contributors badge" /></a> <a
href="https://github.com/sphinx-contrib/zopeext/stargazers"><img
src="https://img.shields.io/github/stars/sphinx-contrib/zopeext.svg?logo=github"
alt="zopeext gh: stars badge" /></a> <a
href="https://github.com/sphinx-contrib/zopeext/issues"><img
src="https://img.shields.io/github/issues/sphinx-contrib/zopeext?logo=github"
alt="zopeext gh: issues badge" /></a></p></li>
<li><p>[mmf-setup][]: A package for helping with development. Has a
script <code>mmf_setup</code> that will setup and environment on <a
href="https://cocalc.com">CoCalc</a>, and has options for installing and
configuring <a href="https://www.mercurial-scm.org/">Mercurial</a>,
Jupyter notebooks, and customizing the import path.</p></li>
<li><p>[mmfutils][]: This package.</p></li>
</ul>
<h2 id="distribution">Distribution</h2>
<p>In general, we will try to distribute projects on <a
href="https://pypi.org" title="PyPI: The Python Package Index">PyPI</a>
and this will be the primary mode if distribution. To use such projects
in a <a href="https://docs.conda.io" title="Conda">Conda</a>
environment, just use <code>pip</code>:</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># environment.yaml</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">...</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">[dependencies]</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">  ...</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">  - pip</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="co">  - pip:</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="co">    - mmfutils&gt;=0.6</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ...</span></span></code></pre></div>
<h2 id="to-do-1">To Do</h2>
<ul>
<li>Consider a two-branch model so that one can easily update to the
latest development branch or the latest default branch. Maybe default
should be the development branch and we should have a release branch?
(Thinking about testing and badges… currently I have a branch for each
version, but this means I need to specify the latest one each
time.)</li>
</ul>
<p>To make packages available before their release on <a
href="https://pypi.org" title="PyPI: The Python Package Index">PyPI</a>,
one can make use of the <a
href="https://pip.pypa.io/en/stable/cli/pip_wheel/?highlight=find-links#cmdoption-f"><code>-f, --find-links &lt;url&gt;</code></a>
option of <code>pip</code>. If this points to a webpage with links, then
these links can define how to get a package from source etc. I maintain
my own set of links in my <a
href="https://alum.mit.edu/www/mforbes/mypi/"
title="MyPI: My personal package index">MyPI</a> project. Unfortunately,
until <a
href="https://gitlab.com/gitlab-org/gitlab/-/issues/22572">issue #22572
<em>(gitlab is completely unusable without javascript.)</em></a> is
resolved, GitLab-based sites are useless for this purpose, so we rely on
mirroring through GitHub.</p>
<p>Starting with version 0.6.0, we reorganized the repository as follows
(modified from the output of <code>tree -L 2</code>:</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> tree <span class="at">-L</span> 2</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> doc</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>   <span class="kw">|</span><span class="ex">--</span> README.py        <span class="co"># Front page as a notebook.</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>   <span class="kw">|</span><span class="ex">--</span> README.ipynb     <span class="co"># Front page as a notebook with output for display on repos.</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>   <span class="ex">...</span>                  <span class="co"># (We don&#39;t commit other .ipynb&#39;s)</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>   <span class="kw">`</span><span class="ex">--</span> source           <span class="co"># Sphinx documentation</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> Makefile             <span class="co"># Record instructions here, like how to test, or build docs.</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> Notes.md             <span class="co"># Developer notes</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> README.rst           <span class="co"># Generated from doc/README.ipynb for display on repos.</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> environment.yml      <span class="co"># Useful development environment... not formal part of package.</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> meta.yaml</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="kw">`</span><span class="at">--</span> src</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>   <span class="kw">`</span><span class="ex">--</span> mmfutils         <span class="co"># This is the main package.</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span><span class="ex">--</span> __init__.py  <span class="co"># Required for packages</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="ex">...</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span><span class="ex">--</span> math</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>   <span class="kw">|</span><span class="ex">--</span> __init__.py</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>   <span class="kw">|</span><span class="ex">--</span> bases</span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>   <span class="kw">|</span>   <span class="kw">|</span><span class="ex">--</span> __init__.py</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>   <span class="kw">|</span>   <span class="ex">...</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>   <span class="kw">|</span>   <span class="kw">`</span><span class="at">--</span> tests                <span class="co"># Tests for mmfutils.math.bases</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>   <span class="kw">|</span>       <span class="kw">`</span><span class="ex">--</span> test_bases.py</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>   <span class="ex">...</span></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>   <span class="kw">`</span><span class="at">--</span> tests                    <span class="co"># Tests for mmfutils.math</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>       <span class="kw">|</span><span class="ex">--</span> test_bessel.py</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>       <span class="ex">...</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">|</span>       <span class="kw">`</span><span class="ex">--</span> test_special.py</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="ex">...</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>       <span class="kw">`</span><span class="at">--</span> tests                        <span class="co"># Tests for mmfutils</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>           <span class="kw">|</span><span class="ex">--</span> test_containers.py</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>           <span class="kw">|</span><span class="ex">--</span> test_context.py</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>           <span class="ex">...</span></span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> noxfile.py</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> pytest.ini</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> requirements.txt</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> setup.cfg</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> setup.py</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a><span class="kw">`</span><span class="ex">--</span> setup_tests</span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">`</span><span class="at">--</span> drone.io.sh</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> noxfile.py</span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> pytest.ini</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> requirements.txt</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> setup.cfg</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">--</span> setup.py</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a><span class="kw">`</span><span class="ex">--</span> setup_tests</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">`</span><span class="at">--</span> drone.io.sh</span></code></pre></div>
<h2 id="version-number">Version Number</h2>
<p>There should be one definitive place for the version number. Options
are discussed here: <a
href="https://packaging.python.org/guides/single-sourcing-package-version">Single-sourcing
the package version</a>. I am going with option 5, which uses
<code>importlib.metadata</code>.</p>
<h1 id="documentation-read-the-docs">Documentation (<a
href="https://readthedocs.org">Read the Docs</a>)</h1>
<p>We like to deploy our documentation on <a
href="https://readthedocs.org">Read the Docs</a> (see e.g. <a
href="https://iscimath-583-learning-from-signals.readthedocs.io/en/latest/">Math
583: Learning from Signals</a>). Our documentation lives in the
<code>Docs/</code> directory and is generally built with <a
href="https://www.sphinx-doc.org/">Sphinx</a> using the <a
href="https://jupyterbook.org/" title="Books with Jupyter">Jupyter
Book</a> framework (see <a
href="https://jupyterbook.org/en/stable/explain/sphinx.html#how-to-replicate-jupyter-books-functionality-in-sphinx">How
to replicate Jupyter Book’s functionality in Sphinx</a>).</p>
<p>To build the documentation, manually, activate the environment, then
run <code>make html</code> in the documentation directory:</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> shell</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> Docs <span class="kw">&amp;&amp;</span> <span class="fu">make</span> html</span></code></pre></div>
<p>Alternatively, while actively working on the documentation, you can
run:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> doc-server</span></code></pre></div>
<p>This will use <a
href="https://github.com/executablebooks/sphinx-autobuild"><code>sphinx-autobuild</code></a>
to build and serve the documentation locally on <a
href="http://127.0.0.1:8000" class="uri">http://127.0.0.1:8000</a>. This
documentation will be updated whenever you change files.</p>
<blockquote>
<p>Caveat: If you documentation literally includes files like
<code>README.md</code> from the top-level, then editing these might not
properly trigger a rebuild. We try to mitigate this, but it is buggy.
See details in the <code>Makefile</code> and
<code>Docs/index.md</code>.</p>
</blockquote>
<p>To deploy the documentation on <a href="https://readthedocs.org">Read
the Docs</a>, push your source to <a href="#github">GitHub</a> or
[GitLab][], then link these to the appropriate project on <a
href="https://readthedocs.org">Read the Docs</a>. Once you establish the
appropriate web-hooks, <a href="https://readthedocs.org">Read the
Docs</a> should automatically pull your changes when you push, and build
the documentation.</p>
<p>The documentation build process is controlled by the
<code>.readthedocs.yaml</code> file. We use the following format:</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .readthedocs.yaml</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sphinx</span><span class="kw">:</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="at">   </span><span class="fu">configuration</span><span class="kw">:</span><span class="at"> Docs/conf.py</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">os</span><span class="kw">:</span><span class="at"> ubuntu-22.04</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tools</span><span class="kw">:</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">python</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;mambaforge-4.10&quot;</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">post_create_environment</span><span class="kw">:</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> python3 -m ipykernel install --user --name math-583</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="fu">conda</span><span class="kw">:</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">environment</span><span class="kw">:</span><span class="at"> environment.yaml</span></span></code></pre></div>
<p>This augments the standard build process to register the
<code>math-583</code> kernel used in the notebooks. Otherwise,
everything is specified in <code>environment.yaml</code>, which can
include <code>.</code> as needed.</p>
<p>If you need more control, you can do something like this:</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .readthedocs.yaml</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">version</span><span class="kw">:</span><span class="at"> </span><span class="dv">2</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sphinx</span><span class="kw">:</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="at">   </span><span class="fu">configuration</span><span class="kw">:</span><span class="at"> Docs/conf.py</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">os</span><span class="kw">:</span><span class="at"> ubuntu-22.04</span></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">tools</span><span class="kw">:</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">python</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;3&quot;</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">commands</span><span class="kw">:</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> make rtd</span></span></code></pre></div>
<p>You must make sure that <code>make rtd</code> puts the generated
documentation in <code>$READTHEDOCS_OUTPUT/html</code>.</p>
<h2 id="jupyter-book">Jupyter Book</h2>
<h3 id="images">Images</h3>
<p>There are several ways to include images in your documents. (<a
href="https://jupyterbook.org/en/stable/content/figures.html">JB Images
and figures</a>).</p>
<ol type="1">
<li><p>Use <a href="https://myst-nb.readthedocs.io/en/latest/">MyST
NB</a> to generate the figures programmatically. The output of the
code-cell will be the figure:</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{code-cell}</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="in">:tags: [hide-input]</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="in">fig, ax = plt.subplots()</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="in">x = np.linspace(-1, 1)</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="in">ax.plot(x, x**2)</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div>
<p>For this to work, I usually include something like the following at
the top of my MyST files.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{code-cell}</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="in">:tags: [hide-cell]</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="in">import mmf_setup; mmf_setup.nbinit()</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="in">from pathlib import Path</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="in">FIG_DIR = Path(mmf_setup.ROOT) / &#39;Docs/_images/&#39;</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="in">os.makedirs(FIG_DIR, exist_ok=True)</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a><span class="in">import logging; logging.getLogger(&quot;matplotlib&quot;).setLevel(logging.CRITICAL)</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="in">%matplotlib inline</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="in">import numpy as np, matplotlib.pyplot as plt</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a><span class="in">try: from myst_nb import glue  # So this runs in plain notebooks without myst_nb</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a><span class="in">except ImportError: glue = None</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div></li>
<li><p>If you want more control over where the image appears, you can <a
href="https://myst-nb.readthedocs.io/en/latest/render/glue.html">glue</a>
it:</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{code-cell}</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="in">:tags: [hide-input]</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="in">fig, ax = plt.subplots()</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="in">x = np.linspace(-1, 1)</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="in">ax.plot(x, x**2)</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="in">if glue:  # So this runs in plain notebooks without myst_nb</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="in">    glue(&quot;fig:parabola, fig)</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>Use it like this for a figure, or margin figure with a caption:</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="in">```{glue:figure} fig:parabola</span></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="in">:figclass: margin</span></span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a><span class="in">This is a **caption**.  This figure is a parabola.</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div>
<p><em>Note: this does not work across notebooks <a
href="https://github.com/executablebooks/MyST-NB/issues/431">MyST_NB
issue #431</a>.</em></p></li>
<li><p>If you want to reference a figure from another document, you
currently must save it. I use <code>mmf_setup.ROOT</code> to locate
this. Here is code that allows you to do all of it.</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{code-cell}</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="in">:tags: [hide-input]</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="in">fig, ax = plt.subplots()</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="in">x = np.linspace(-1, 1)</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="in">ax.plot(x, x**2)</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="in">plt.savefig(FIG_DIR / &quot;parabola.svg&quot;)</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>Now you can use this with a standard <span class="in">`figure`</span> environment.</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="in">```{figure} /_images/parabola.svg</span></span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="in">:figclass: margin</span></span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="in">This is a **caption**.  This figure is a parabola.</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div></li>
</ol>
<p>Here is complete code that does it all for reference. (I prefer to
break it up.)</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{code-cell}</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="in">:tags: [hide-input]</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="in">import mmf_setup; mmf_setup.nbinit()</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="in">from pathlib import Path</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="in">FIG_DIR = Path(mmf_setup.ROOT) / &#39;Docs/_images/&#39;</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="in">os.makedirs(FIG_DIR, exist_ok=True)</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="in">import logging; logging.getLogger(&quot;matplotlib&quot;).setLevel(logging.CRITICAL)</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="in">%matplotlib inline</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="in">import numpy as np, matplotlib.pyplot as plt</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="in">try: from myst_nb import glue  # So this runs in plain notebooks without myst_nb</span></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a><span class="in">except ImportError: glue = None</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a><span class="in">fig, ax = plt.subplots()</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a><span class="in">x = np.linspace(-1, 1)</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="in">ax.plot(x, x**2)</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="in">if glue:  # So this runs in plain notebooks without myst_nb</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="in">    glue(&quot;fig:parabola, fig)</span></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="in">plt.savefig(FIG_DIR / &quot;parabola.svg&quot;)   # For HTML</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="in">plt.savefig(FIG_DIR / &quot;parabola.pdf&quot;)   # For LaTeX</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div>
<h1 id="repositories">Repositories</h1>
<p>Currently the main repository is on our own <a
href="https://heptapod.net" title="Heptapod website">Heptapod</a>
server, but I have enabled
<code>Settings/Repository/Mirroring repositories</code> to push to a
public GitHub mirror https://github.com/forbes-group/mmfutils/. This
required getting a personal token from GitHub as <a
href="https://hg.iscimath.org/help/user/project/repository/repository_mirroring#setting-up-a-push-mirror-from-gitlab-to-github">described
here</a>. I chose to <code>Mirror only protected branches</code> to keep
things clean, but this means that we should either make all release
branches protected, or be careful to tag the releases.</p>
<p>I don’t want to use GitHub for managing issues or pull-requests, so
instead, I also maintain a development fork (under my personal GitHub
account) which I can use for code reviews. For this one, I mirror
everything.</p>
<blockquote>
<p>Notes:</p>
<ul>
<li>Do not actually fork the project - just push from Heptapod. (LGTM
will not analyze forks).</li>
<li>If you want to be able to update GitHub workflows, you must grant
<code>workflow</code> permission for the token. Doing this will not
invalidate the token.</li>
</ul>
</blockquote>
<p>Summary:</p>
<ul>
<li>https://hg.iscimath.org/forbes-group/mmfutils: Main development
repository (Mercurial) running on our hosted <a
href="https://heptapod.net" title="Heptapod website">Heptapod</a>
server. This is where <a
href="https://hg.iscimath.org/forbes-group/mmfutils/-issues">Issues</a>,
<a
href="https://hg.iscimath.org/forbes-group/mmfutils/-/merge_requests">Merge
Requests</a> etc. should be reported here.</li>
<li>https://github.com/forbes-group/mmfutils: Main public mirror (Git)
for releases. Protected branches are automatically pushed here. No
development work should be done here: this is just for public access,
and to use GitHub’s CI tools.</li>
<li>https://github.com/mforbes/mmfutils-fork: My development fork (Git).
Everything is pushed here to use GitHub’s CI tools during development.
Should not be used for anything else.</li>
</ul>
<h2 id="badges">Badges</h2>
<p>With CI setup, we have the following badges:</p>
<ul>
<li><p>Documentation at <a href="https://readthedocs.org">Read the
Docs</a>.</p>
<p><a
href="https://mmfutils.readthedocs.io/en/latest/?badge=latest"><img
src="https://readthedocs.org/projects/mmfutils/badge/?version=latest"
alt="Documentation Status" /></a></p></li>
<li><p>Testing at <a href="https://cloud.drone.io">DroneIO</a> and with
GitHub actions:</p>
<p><a href="https://cloud.drone.io/forbes-group/mmfutils"><img
src="https://cloud.drone.io/api/badges/forbes-group/mmfutils/status.svg"
alt="DroneIO Build Status" /></a> <a
href="https://github.com/mforbes/mmfutils-fork/actions/workflows/tests.yml"><img
src="https://github.com/mforbes/mmfutils-fork/actions/workflows/tests.yml/badge.svg?branch=topic%2F0.6.0%2Fgithub_ci"
alt="Tests" /></a></p></li>
<li><p>Code quality testing at <a href="https://lgtm.com">lgtm</a>:</p>
<p><a
href="https://lgtm.com/projects/g/forbes-group/mmfutils/context:python"><img
src="https://img.shields.io/lgtm/grade/python/g/forbes-group/mmfutils.svg?logo=lgtm&amp;logoWidth=18"
alt="Language grade: Python" /></a> <a
href="https://lgtm.com/projects/g/forbes-group/mmfutils/context:python"><img
src="https://img.shields.io/lgtm/grade/python/g/mforbes/mmfutils-fork.svg?logo=lgtm&amp;logoWidth=18"
alt="Language grade: Python" /></a></p></li>
<li><p>Style:</p>
<p><a href="https://black.readthedocs.io/en/stable/"><img
src="https://img.shields.io/badge/code%20style-black-000000.svg"
alt="Code style: black" /></a></p></li>
</ul>
<h2 id="continuous-integration-ci">Continuous Integration (CI)</h2>
<p>As mentioned above, by providing <a
href=".github/workflows/tests.yml"><code>.github/workflows/tests.yml</code></a>,
we can engage a <a
href="https://docs.github.com/en/actions/guides/about-continuous-integration">GitHub
action for continuous integration</a>. This can be configure to run the
tests automatically on pushes, the results of which are displayed in the
appropriate badges.</p>
<p>The main difficulty I had was a need for a full LaTeX installation.
This is now working with <code>apt-get texlive-full</code>, but could
probably be simplified, just updating the packages we really need for
testing (<a href="https://ctan.org/pkg/mathpazo"
title="mathpazo – Fonts to typeset mathematics to match Palatino"><code>mathpazo</code></a>,
<a href="https://ctan.org/pkg/siunitx"
title="siunitx – A comprehensive (SI) units package"><code>siunitx</code></a>,
and <a href="https://ctan.org/pkg/type1cm"
title="type1cm – Arbitrary size font selection in LaTeX"><code>type1cm</code></a>
were issues when just using the smaller <a
href="https://www.tug.org/texlive/"><code>texlive</code></a>
package.)</p>
<h3 id="coverage">Coverage</h3>
<p>For general coverage, it is enough to install
[<code>pytest-cov</code>][], but this does not work so well for CI.</p>
<p>For <a href="#github">GitHub</a>, see <a
href="https://hynek.me/articles/ditch-codecov-python/">How to Ditch
Codecov for Python Projects</a> and the <a
href="https://github.com/cjolowicz/cookiecutter-hypermodern-python/blob/main/%7B%7Bcookiecutter.project_name%7D%7D/.github/workflows/tests.yml">Hypermodern
GitHub workflow</a>. This is a little tricky, because the tests are run
in separate machines. The coverage reports need to be labeled
individually, then uploaded as artifacts, and finally combined after all
tests are run. Following the <a
href="https://github.com/cjolowicz/cookiecutter-hypermodern-python/blob/main/%7B%7Bcookiecutter.project_name%7D%7D/.github/workflows/tests.yml">Hypermodern
GitHub workflow</a>, we include a <code>coverage</code> session in
<code>noxfile.py</code>. Here ate some potential gotchas.</p>
<ul>
<li><p>You need to have at least the following in your
<code>pyproject.toml</code> file:</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">tool</span><span class="kw">.</span><span class="dt">coverage</span><span class="kw">.</span><span class="dt">run</span><span class="kw">]</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="dt">relative_files</span> <span class="op">=</span> <span class="cn">true</span>     <span class="co"># Remove the .nox/test-3-10 etc. prefix.</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="dt">parallel</span> <span class="op">=</span> <span class="cn">true</span>           <span class="co"># Needed to generate .coverage.* files for each process</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="dt">source</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;mmfutils&quot;</span><span class="op">]</span>     <span class="co"># This the installed package.</span></span></code></pre></div></li>
<li><p>Be careful with [<code>pytest-cov</code>][]: It will generate
reports and eat the coverage files that you are trying to combine. I
think I recommend not using this, and relying on <a
href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">Nox</a>.</p></li>
<li><p>If you put the reports in a directory, you must specify
this.</p></li>
</ul>
<ul>
<li>https://docs.gitlab.com/ee/user/project/badges.html</li>
</ul>
<p>Old:</p>
<p>For <a href="#github">GitHub</a> one can use <a
href="https://app.codecov.io/">Codecov</a>. To do this, sign in, the
link your <a href="#github">GitHub</a> account. Once you give
permissions, you can then add public repos. You will need to add the
<code>CODECOV_TOKEN</code> token as a repository secret. Once this is
done, you can add the following to your
<code>.github/workflows/tests.yaml</code> workflow:</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Upload coverage reports to Codecov</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> codecov/codecov-action@v3</span></span></code></pre></div>
<h2 id="references-1">References</h2>
<ul>
<li>https://stackoverflow.com/questions/67482906/show-coverage-in-github-pr:
Discussion of how to get coverage reports to show in pull requests on <a
href="#github">GitHub</a>.</li>
<li>https://cjolowicz.github.io/posts/hypermodern-python-06-ci-cd/</li>
<li>https://docs.github.com/en/actions/guides/setting-up-continuous-integration-using-workflow-templates</li>
</ul>
<h1 id="testing-1">Testing</h1>
<p>We use <a href="https://docs.pytest.org/en/latest/"
title="pytest">pytest</a> for testing, running the tests with <a
href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">Nox</a> for multiple versions of
python. If you have multiple cores, you can run tests in parallel by
passing the number with <code>PYTEST_ADDPOPTS</code>:</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean                      <span class="co"># Remove any .pyc files etc... these can muckup tests.</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PYTEST_ADDOPTS</span><span class="op">=</span><span class="st">&quot;-n 8&quot;</span>    <span class="co"># Use 8 processes for testing in parallel</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="ex">nox</span></span></code></pre></div>
<p>There are <a
href="https://docs.pytest.org/en/latest/explanation/goodpractices.html#choosing-a-test-layout-import-rules">two
conventions</a> for locating tests: outside of the application code, or
with the application code. Some advantages of the former are <a
href="https://blog.ionelmc.ro/2014/05/25/python-packaging/#the-structure">discussed
by Ionel Cristian Mărieș</a>. He gives four main points which we discuss
here:</p>
<blockquote>
<p>Module discovery tools will trip over your test modules. Strange
things usually happen in test module. The help builtin does module
discovery. E.g.:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> <span class="bu">help</span>(<span class="st">&#39;modules&#39;</span>)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>Please wait a moment <span class="cf">while</span> I gather a <span class="bu">list</span> of <span class="bu">all</span> available modules...</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>__future__          antigravity         html                select</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>...</span></code></pre></div>
</blockquote>
<p>I need to play with this a bit later… might still be an issue.</p>
<blockquote>
<p>Tests usually require additional dependencies to run, so they aren’t
useful by their own - you can’t run them directly.</p>
</blockquote>
<p>I provide a <code>[test]</code> extra, so users can get all the
dependencies with <code>python3 -m pip install .[test]</code>.</p>
<blockquote>
<p>Tests are concerned with development, not usage.</p>
</blockquote>
<p>and</p>
<blockquote>
<p>It’s extremely unlikely that the user of the library will run the
tests instead of the library’s developer. E.g.: you don’t run the tests
for Django while testing your apps - Django is already tested.</p>
</blockquote>
<p>Both these assumptions are not valid for research code: here the
tests often provide useful examples for the users about how things can
be done. Also, the users are often the developers.</p>
<h2 id="tests__init__.py"><code>tests/__init__.py</code></h2>
<p>Should the <code>tests</code> directories be importable modules as
signified by having <code>__init__.py</code> files? In our case, yes,
because several of them have associated modules needed for testing (in
particular <code>src/mmfutils/tests/parallel_module.py</code>) and not
having <code>__init__.py</code> files creates a problem for which I do
not have an easy solution. This may also help with potential name
classes as discussed in the <a
href="https://docs.pytest.org/en/stable/goodpractices.html#tests-outside-application-code">pytest
documentation</a>.</p>
<h2 id="nox">Nox</h2>
<p>Testing is now done using <a href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">Nox</a> as configured in
<code>noxfile.py</code>. This allows for testing against multiple
versions of python (similar to [Tox]) but I find that it is simpler to
use and works with <a href="https://docs.conda.io"
title="Conda">Conda</a>. My general strategy is to use <a
href="https://docs.conda.io" title="Conda">Conda</a> to minimally
provision environments with the desired version of python, then to
install the package with <code>pip install .[test]</code> in that
environment. This has the following advantages:</p>
<ul>
<li><p>Generally works. The typical recommendation (for example in the
<a href="https://cjolowicz.github.io/posts/hypermodern-python-01-setup/"
title="Hypermodern Python">Hypermodern Python</a> series) is to use <a
href="https://github.com/pyenv/pyenv"
title="Simple Python Version Management: pyenv">PyEnv</a>.
Unfortunately, this is a pain for me on my Mac OS X development machine
as <a href="https://github.com/pyenv/pyenv"
title="Simple Python Version Management: pyenv">PyEnv</a> tries to
compile python from source which can take forever, and often fails. (For
example, I cannot build <code>python=3.5.8</code> for some reason, and
<code>miniconda3-3.5.*</code> is not available.) Conversely,
<code>conda env create -n   py3.5 python=3.5</code> seems to always work
for me. Of course, this does require you to install
[<code>miniconda</code>][] on your machine, which I do with something
like this:</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># I install conda as a non-privileged user in /data/apps/conda </span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="va">CONDA_PATH</span><span class="op">=</span>/data/apps/conda1</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="va">CONDA_USER</span><span class="op">=</span>mforbes</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> <span class="at">-u</span> <span class="st">&quot;</span><span class="va">$CONDA_USER</span><span class="st">&quot;</span> mkdir <span class="at">-p</span> <span class="st">&quot;</span><span class="va">$CONDA_PATH</span><span class="st">&quot;</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="fu">wget</span> https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="ex">shasum</span> <span class="at">-a</span> 256 Miniconda3-latest-MacOSX-x86_64.sh</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="co"># The following runs in batch mode: be sure to read the license before you do this.</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="fu">bash</span> Miniconda3-latest-MacOSX-x86_64.sh <span class="at">-f</span> <span class="at">-b</span> <span class="at">-p</span> <span class="st">&quot;</span><span class="va">$CONDA_PATH</span><span class="st">&quot;</span></span></code></pre></div></li>
<li><p>This approach only used <a href="https://docs.conda.io"
title="Conda">Conda</a> to install python: we then test
<code>pip install</code> which we certainly want to test.</p></li>
<li><p>We can use <a href="https://docs.conda.io"
title="Conda">Conda</a> if we like to test installing dependencies from
an <code>environment.yml</code> file for example.</p></li>
</ul>
<p>Tests should be run as follows:</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nox</span> <span class="at">-s</span> test_conda <span class="at">-p</span> 3.6</span></code></pre></div>
<p>This runs the test against the latest version of Python 3.6,
essentially running something like:</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create <span class="at">-p</span> .nox/test_conda-3-6</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate ./.nox/test_conda-3-6</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install .[test]</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="ex">pytest</span></span></code></pre></div>
<p>If this fails, you can debug by simply activating the
environment:</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env create <span class="at">-p</span> .nox/test_conda-3-6</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pytest</span></span></code></pre></div>
<p>or using the environment defined in <code>environment.yml</code>:</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cond</span> activate _mmfutils</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pytest</span></span></code></pre></div>
<h3 id="matrix-testing">Matrix Testing</h3>
<p>Here is an example <code>noxfile.py</code> to test a “matrix” of
versions, with some exceptions that do not work:</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># noxfile.py</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nox</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>python_versions <span class="op">=</span> [<span class="st">&quot;3.7&quot;</span>, <span class="st">&quot;3.8&quot;</span>, <span class="st">&quot;3.9&quot;</span>, <span class="st">&quot;3.10&quot;</span>, <span class="st">&quot;3.11&quot;</span>]</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>sphinx_versions <span class="op">=</span> {_p: [<span class="st">&quot;4.5.0&quot;</span>, <span class="st">&quot;5.3.0&quot;</span>, <span class="st">&quot;6.1.3&quot;</span>] <span class="cf">for</span> _p <span class="kw">in</span> python_versions}</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>excluded_versions <span class="op">=</span> {(<span class="st">&quot;3.7&quot;</span>, <span class="st">&quot;6.1.3&quot;</span>)}</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>python_sphinx <span class="op">=</span> [</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>    (python, sphinx)</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> python <span class="kw">in</span> python_versions</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sphinx <span class="kw">in</span> sphinx_versions[python]</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (python, sphinx) <span class="kw">not</span> <span class="kw">in</span> excluded_versions</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="at">@nox.session</span>(reuse_venv<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="at">@nox.parametrize</span>(<span class="st">&quot;python,sphinx&quot;</span>, python_sphinx)</span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test(session, sphinx):</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>    session.install(<span class="st">&quot;.[test]&quot;</span>, <span class="ss">f&quot;sphinx[test]~=</span><span class="sc">{</span>sphinx<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>    session.run(<span class="st">&quot;pytest&quot;</span>, <span class="st">&quot;tests&quot;</span>)</span></code></pre></div>
<p>I would really like to programmatically determine the allowed
versions from <a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata"><code>pyproject.toml</code></a>,
and there is an option for doing this with poetry (see <a
href="https://github.com/cjolowicz/nox-poetry/discussions/289">this
discussion</a>) but I have not found something that works with <a
href="https://pdm.fming.dev/latest/">PDM</a>. (I asked <a
href="">here</a>)</p>
<h3 id="gotchas">Gotchas</h3>
<p>I had a very difficult time with random errors when tested
<code>mmf_setup</code> that boiled down to <code>pip</code> not
installing some packages in the testing environment because they were in
<code>~/.local</code>, but then having issues when the underlying tests
were running and sometimes did not have access to these. (The specific
case was when running <code>run_tests.py</code> for Mercurial
tests.)</p>
<p>The solution is to make sure that <code>PYTHONNOUSERSITE=1</code>
before running anything.</p>
<ul>
<li>See: https://stackoverflow.com/a/51640558/1088938</li>
</ul>
<h2 id="documentation">Documentation</h2>
<p>If you are a developer of this package, there are a few things to be
aware of.</p>
<ol type="1">
<li><p>If you modify the notebooks in <code>docs/notebooks</code> then
you may need to regenerate some of the <code>.rst</code> files and
commit them so they appear on bitbucket. This is done automatically by
the <code>pre-commit</code> hook in <code>.hgrc</code> if you include
this in your <code>.hg/hgrc</code> file with a line like:</p>
<pre><code># %include ../.hgrc</code></pre></li>
</ol>
<p><strong>Security Warning:</strong> if you do this, be sure to inspect
the <code>.hgrc</code> file carefully to make sure that no one inserts
malicious code. This runs the following code:</p>
<pre><code>!cd $ROOTDIR; jupyter nbconvert --to=rst --output=README.rst doc/README.ipynb</code></pre>
<h1 id="profiling-incomplete">Profiling (Incomplete)</h1>
<p>To measure peak memory usage, look at <a
href="https://pythonspeed.com/products/filmemoryprofiler/"
title="The Fil memory profiler for Python">Fil</a>. Write your test-code
as a script, then run it with <code>fil-profile</code>:</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="ex">fil-profile</span> run test_script.py</span></code></pre></div>
<h1 id="releases">Releases</h1>
<p>We try to keep the repository clean with the following
properties:</p>
<ol type="1">
<li>The default branch is stable: i.e. if someone runs
<code>hg clone</code>, this will pull the latest stable release.</li>
<li>Each release has its own named branch so that
e.g. <code>hg up 0.5.0</code> will get the right thing. Note: this
should update to the development branch, <em>not</em> the default branch
so that any work committed will not pollute the development branch
(which would violate the previous point).</li>
</ol>
<p>To do this, we advocate the following procedure.</p>
<ol type="1">
<li><p><strong>Update to Correct Branch</strong>: Make sure this is the
correct development branch, not the default branch by explicitly
updating:</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hg</span> up <span class="op">&lt;</span>version<span class="op">&gt;</span></span></code></pre></div>
<p>(Compare with <code>hg up default</code> which should take you to the
default branch instead.)</p></li>
<li><p><strong>Work</strong>: Do your work, committing as required with
messages as shown in the repository with the following keys:</p>
<ul>
<li><code>DOC</code>: Documentation changes.</li>
<li><code>API</code>: Changes to the exising API. This could break old
code.</li>
<li><code>EHN</code>: Enhancement or new functionality. Without an
<code>API</code> tag, these should not break existing codes.</li>
<li><code>BLD</code>: Build system changes (<code>setup.py</code>,
<code>requirements.txt</code> etc.)</li>
<li><code>TST</code>: Update tests, code coverage, etc.</li>
<li><code>BUG</code>: Address an issue as filed on the issue
tracker.</li>
<li><code>BRN</code>: Start a new branch (see below).</li>
<li><code>REL</code>: Release (see below).</li>
<li><code>WIP</code>: Work in progress. Do not depend on these! They
will be stripped. This is useful when testing things like the rendering
of documentation on bitbucket etc. where you need to push an incomplete
set of files. Please collapse and strip these eventually when you get
things working.</li>
<li><code>CHK</code>: Checkpoints. These should not be pushed to
bitbucket!</li>
</ul></li>
<li><p><strong>Tests</strong>: Make sure the tests pass. Comprehensive
tests should be run with <code>nox</code>:</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="ex">nox</span></span></code></pre></div>
<p>Quick tests while developing can be run with the
<code>_mmfutils</code> environment:</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> env update <span class="at">--file</span> environment.yml</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate _mmfutils<span class="kw">;</span> <span class="ex">pytest</span></span></code></pre></div>
<p>(<code>hg com</code> will automatically run tests after
pip-installing everything in <code>setup.py</code> if you have linked
the <code>.hgrc</code> file as discussed above, but the use of
independent environments is preferred now.)</p></li>
<li><p><strong>Update Docs</strong>: Update the documentation if needed.
To generate new documentation run:</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> shell</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> doc</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="ex">sphinx-apidoc</span> <span class="at">-eTE</span> ../src/mmfutils <span class="at">-o</span> source</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> source/mmfutils.<span class="pp">*</span>tests<span class="pp">*</span></span></code></pre></div>
<ul>
<li>Include any changes at the bottom of this file
(<code>doc/README.ipynb</code>).</li>
<li>You may need to copy new figures to <code>README_files/</code> if
the figure numbers have changed, and then <code>hg add</code> these
while <code>hg rm</code> the old ones.</li>
</ul>
<p>Edit any new files created (titles often need to be added) and check
that this looks good with</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> html</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> build/html/index.html</span></code></pre></div>
<p>Look especially for errors of the type “WARNING: document isn’t
included in any toctree”. This indicates that you probably need to add
the module to an upper level <code>.. toctree::</code>. Also look for
“WARNING: toctree contains reference to document u’…’ that doesn’t have
a title: no link will be generated”. This indicates you need to add a
title to a new file. For example, when I added the
<code>mmf.math.optimize</code> module, I needed to update the
following:</p></li>
</ol>
<div class="sourceCode" id="cb69"><pre
class="sourceCode rst"><code class="sourceCode rest"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co">   .. doc/source/mmfutils.rst</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>   mmfutils</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>   ========</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="dt">   .. toctree::</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>       ...</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>       mmfutils.optimize</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>       ...</span></code></pre></div>
<div class="sourceCode" id="cb70"><pre
class="sourceCode rst"><code class="sourceCode rest"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">   .. doc/source/mmfutils.optimize.rst</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>   mmfutils.optimize</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>   =================</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>       </span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="dt">   .. automodule:: </span>mmfutils.optimize</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>       <span class="fu">:members:</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>       <span class="fu">:undoc-members:</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">:show-inheritance:</span></span></code></pre></div>
<ol start="5" type="1">
<li><p><strong>Clean up History</strong>: Run <code>hg histedit</code>,
<code>hg rebase</code>, or <code>hg strip</code> as needed to clean up
the repo before you push. Branches should generally be linear unless
there is an exceptional reason to split development.</p></li>
<li><p><strong>Release</strong>: First edit <code>pyproject.toml</code>
to update the version number by removing the <code>dev</code> part of
the version number. Commit only this change and then push only the
branch you are working on:</p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hg</span> com <span class="at">-m</span> <span class="st">&quot;REL: &lt;version&gt;&quot;</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="ex">hg</span> push <span class="at">-b</span> .</span></code></pre></div></li>
<li><p><strong>Pull Request</strong>: Create a pull request on the
development fork from your branch to <code>default</code> on the release
project. Review it, fix anything, then accept the merge request.
<strong>Do not close the branch!</strong> Unlike bitbucket, if you close
the branch on Heptapod, it will vanish, breaking our <a
href="https://alum.mit.edu/www/mforbes/mypi/"
title="MyPI: My personal package index">MyPI</a> index.</p></li>
<li><p><strong>Publish on PyPI</strong>: Publish the released version on
<a href="https://pypi.org/project/mmfutils/">PyPI</a> using <a
href="https://pypi.org/project/twine/">twine</a></p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the package.</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> setup.py sdist bdist_wheel</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Test that everything looks right:</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="ex">twine</span> upload <span class="at">--repository-url</span> https://test.pypi.org/legacy/ dist/<span class="pp">*</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Upload to PyPI</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="ex">twine</span> upload dist/<span class="pp">*</span></span></code></pre></div></li>
<li><p><strong>Build Conda Package</strong>: This will run all the tests
in a fresh environment as specified by <code>meta.yaml</code>. Make sure
that the dependencies in <code>meta.yaml</code>,
<code>environment.yml</code>, and <code>setup.py</code> are consistent.
Note that the list of versions to be built is specified in
<code>conda_build_config.yaml</code>.</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> build .</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> build . <span class="at">--output</span>   <span class="co"># Use this below</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="ex">anaconda</span> login</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="ex">anaconda</span> upload <span class="at">--all</span> /data/apps/conda/conda-bld/noarch/mmfutils-0.5.0-py_0.tar.bz2</span></code></pre></div></li>
<li><p><strong>Start new branch</strong>: On the same development branch
(not <code>default</code>), increase the version number in
<code>mmfutils/__init__.py</code> and add <code>dev</code>: i.e.:</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>__version__ <span class="op">=</span> <span class="st">&#39;0.5.1dev&#39;</span></span></code></pre></div>
<p>Then create this branch and commit this:</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="ex">hg</span> branch <span class="st">&quot;0.5.1&quot;</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="ex">hg</span> com <span class="at">-m</span> <span class="st">&quot;BRN: Started branch 0.5.1&quot;</span></span></code></pre></div></li>
<li><p>Optional: Update any <code>setup.py</code> files that depend on
your new features/fixes etc.</p></li>
</ol>
<h1 id="mmfutils-this-package"><code>mmfutils</code>: This Package</h1>
<p>Here we have details about this package specifically. <em>Note: I
think I am recommending <a href="https://pdm.fming.dev/latest/">PDM</a>
for package management but have not completely decided, so wherever you
see <a href="https://pdm.fming.dev/latest/">PDM</a> referenced below,
please consider that this might change to <a
href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>,
<a href="https://hatch.pypa.io/latest/">Hatch</a>, or something similar
in the future.</em></p>
<h2 id="dependencies">Dependencies</h2>
<p>We specify project dependencies in three places:</p>
<ul>
<li><p><code>anaconda-project.yaml</code>: This contains any
dependencies that should be installed with <a
href="https://docs.conda.io" title="Conda">Conda</a>, especially binary
dependencies. In principle, this provides a complete solution with both
<a href="https://docs.conda.io" title="Conda">Conda</a> and <a
href="https://pip.pypa.io/en/stable/">Pip</a> sections as well as the
ability to define custom commands. I played with this for a while, and
it can be quite convenient, but once dependencies become sufficiently
complicated, it becomes advantageous to used <a
href="https://pdm.fming.dev/latest/">PDM</a> or <a
href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
to manage the python dependencies in <a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata"><code>pyproject.toml</code></a>.
If you are starting from scratch (i.e. not using our
[cookiecutters][]</p>
<p>As we discuss below, we can include python-version specific
dependencies in sub-environments if needed. We might be able to also
specify some platform-dependent dependencies in sub-environments but
have not yet explored this.</p>
<p>In principle, <code>anaconda-project add-packages</code> could be
used for this, but currently this can cause problems, so we recommend
just editing <code>anaconda-project.yaml</code> by hand for now. This
should be pretty minimal: things like <code>pyfftw</code> or
<code>cupy</code> that have tight integration with binary
packages.</p></li>
</ul>
<h2 id="the-development-process-makefiles">The Development Process:
Makefiles</h2>
<p>We currently drive our development process with <a
href="https://www.gnu.org/software/make/manual/make.html">GNU make</a>
as specified in the project <code>Makefile</code>. This encodes all of
our “wisdom” about platform dependence etc. We specifically provide the
following targets:</p>
<ul>
<li><code>make init</code>: Initialize the environment and make sure
packages are up to date.</li>
<li><code>make shell</code>: Depends on <code>make init</code> and then
open a shell that one can use to run commands in the project such as
<code>jupyter notebook</code>, or <code>pytest</code>. This is most
similar to <code>poetry shell</code>.</li>
<li><code>make qshell</code>: Do this quickly without checking. This
will create the environment if needed (<code>make dev</code>) but will
not check or update an existing environment.</li>
<li><code>make clean</code>: Remove most intermediate files. Often this
will leave environments available so that it is easy to resume work, but
will remove temporary files, log files, etc.</li>
<li><code>make realclean</code>: Remove as much as possible, including
all environments, installed kernels etc. This should be the equivalent
of “get everything except the source off of my computer and reclaim as
much disk space as possible”. After this command, you should be very
close to</li>
<li><code>make test</code>: This should run all of the tests in the
development environment.</li>
<li><code>make doc-server</code>: If the project has documentation, then
this launch the documentation server.</li>
<li><code>make dev</code>: This builds the development environment. It
is not intended to be used explicitly, but is done by many other
commands like <code>make shell</code>. Currently, this is done as
follows:
<ol type="1">
<li>Some form of <code>conda</code> is used to create an environment in
<code>envs/</code>. This will contain a version of <code>python</code>
as well as any libraries that may be needed (<code>fftw</code>,
<code>cuda</code> etc.)</li>
<li><code>PDM</code> or <code>poetry</code> will be instructed to use
this environment and will install the project and its dev
dependencies.</li>
</ol></li>
<li><code>make info</code>: Print debugging information.</li>
</ul>
<h3 id="details">Details</h3>
<p>We support several options defined by the following flags: *
<code>USE_ANACONDA_PROJECT</code>: Use <a
href="https://anaconda-project.readthedocs.io/en/latest/">Anaconda
Project</a> to build environments. * <code>USE_PDM</code>: Use <a
href="https://pdm.fming.dev/latest/">PDM</a> to install pure python
packages. * <code>USE_POETRY</code>: Use <a
href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
to install pure python packages.</p>
<p>Only one of <code>USE_PDM</code> or <code>USE_POETRY</code> should be
true, but these can be used with or without
<code>USE_ANACONDA_PROJECT</code>.</p>
<p>Some environmental variables need to be exported to subcommands. To
do this, we must enclose commands in parentheses:</p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> CONDA_SUBDIR=osx-64 pdm run echo <span class="va">$CONDA_SUBDIR</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> <span class="er">(</span><span class="bu">export</span> <span class="va">CONDA_SUBDIR</span><span class="op">=</span>osx-64 <span class="kw">&amp;&amp;</span> <span class="ex">pdm</span> run echo <span class="va">$CONDA_SUBDIR</span><span class="kw">)</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="ex">osx-64</span></span></code></pre></div>
<h4 id="conda-and-anaconda-project">Conda and Anaconda Project</h4>
<p>To build the <a href="https://docs.conda.io" title="Conda">Conda</a>
environments we use <a
href="https://anaconda-project.readthedocs.io/en/latest/">Anaconda
Project</a> for a couple of reasons. First, we can specify all of our
dependencies and it still functions like an
<code>environment.yaml</code> file, as long as we rename
<code>packages:</code> to <code>dependencies:</code>. Second, this
allows us to customize environments for different versions of python.
Our <code>Makefile</code> runs
<code>anaconda-project add-env-spec</code>, which will fill these out if
they were not initially provided by the project.</p>
<p>We then install the development tools into this environment using <a
href="https://pdm.fming.dev/latest/">PDM</a>, <a
href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>,
or <a href="https://pip.pypa.io/en/stable/">Pip</a>. <em>Initially I
tried simply using the conda environment for the interpreter with a
custom virtual environment managed by these tools, but this fails in
many cases. For example, even if we install <a
href="https://github.com/pyFFTW/pyFFTW">PyFFTW</a> in the conda
environment, these tools cannot compile it because the underlying
<code>fftw</code> library does not exist. One must then be careful that
everything matches so that the <code>PDM</code>/<code>Poetry</code>
install accepts it.</em></p>
<p>In principle, the <code>anaconda-project.yaml</code> file can replace
the <code>Makefile</code> (by defining <code>commands</code>) and <a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata"><code>pyproject.toml</code></a>
(using the <code>pip:</code> section of <code>dependencies:</code>), but
this does not work for us in all cases. For example, on my new <a
href="https://www.arm.com">ARM</a> Mac, I sometimes need to create an
environment using <code>CONDA_SUBDIR=osx-x64</code> (Intel) as opposed
to <code>CONDA_SUBDIR=osx-arm64</code>. Until issue <a
href="https://github.com/Anaconda-Platform/anaconda-project/issues/392">anaconda-project#392</a>
is resolved, the only way for this to work is for this to be set
<strong>before</strong> calling <code>anaconda-project</code>, but I
can’t remember this, so I want this codified in my
<code>Makefile</code>. This may be a viable option in the future.</p>
<p>One can control the version of python by setting
<code>DEV_PYTHON_VER</code>.</p>
<p>Our development process is outlined in <code>Makefile</code>, and
works as follows. First we explain in simple terms:</p>
<ul>
<li>We use <code>conda</code> to create a development environment in
<code>envs/name-py3.9</code>. with the</li>
</ul>
<h3 id="things-that-did-not-work">Things that Did Not Work</h3>
<ul>
<li><p>Creating a <a href="https://docs.conda.io"
title="Conda">conda</a> environment with binary dependencies, but then
just using the conda-installed python in other virtual environments. For
example, creating a conda environment with <a
href="https://github.com/pyFFTW/pyFFTW">pyfftw</a> would not allow one
to build <a href="https://github.com/pyFFTW/pyFFTW">pyfftw</a> from
source. The <a
href="https://fosstodon.org/@tacaswell/109548682896553945">moral</a> is
that <a href="https://docs.conda.io" title="Conda">Conda</a>
environments need to be activated to work. The only case where we break
this assumption is when we use <a href="https://docs.conda.io"
title="Conda">Conda</a> to install <strong>only</strong> python for <a
href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">nox</a> to use. I think in this
case it would be better to get <a
href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">nox</a> to do this on its own, but
am not yet sure how to deal with platform dependence.</p>
<p>(The specific issue was that, on my new Mac M1 Max with an ARM
processor, sometimes I needed to use Rosetta
i.e. <code>CONDA_SUBDIR=osx-x64</code> as opposed to
<code>CONDA_SUBDIR=osx-arm64</code>. Another issue, now resolved, was
that the ARM version of Python 3.11 was only available on
<code>conda-forge</code>, but I try to avoid included
<code>conda-forge</code> in my channels for performance
reasons.)</p></li>
<li><p>With my <a
href="https://github.com/sphinx-contrib/zopeext">zopeext</a> project, I
tried to support a variety of different versions of Python and Sphinx.
Unfortunately, there seems to be no good way of doing this:</p>
<ul>
<li><p>There is no simple “matrix” of versions that work together. For
example, consider Python 3.7 and Sphinx 3.4.3:</p>
<div class="sourceCode" id="cb77"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3.7 <span class="at">-m</span> venv .venv</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> . .venv/bin/activate</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">.venv</span><span class="kw">)</span> <span class="ex">$</span> pip install sphinx[test]==3.4.3</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">.venv</span><span class="kw">)</span> <span class="ex">$</span> python3.7 <span class="at">-c</span> <span class="st">&quot;import sphinx.testing.fixtures&quot;</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Traceback</span> <span class="er">(</span><span class="ex">most</span> recent call last<span class="kw">)</span><span class="bu">:</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">File</span> <span class="st">&quot;.../.venv/lib/python3.7/site-packages/sphinx/util/rst.py&quot;</span>, line 21, in <span class="op">&lt;</span>module<span class="op">&gt;</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">from</span> jinja2 import Environment, environmentfilter</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="ex">ImportError:</span> cannot import name <span class="st">&#39;environmentfilter&#39;</span> from <span class="st">&#39;jinja2&#39;</span> <span class="er">(</span><span class="ex">.../.venv/lib/python3.7/site-packages/jinja2/__init__.py</span><span class="kw">)</span></span></code></pre></div>
<p>To resolve this, one needs to pin <code>jinja2&lt;3.0.0</code>…</p>
<div class="sourceCode" id="cb78"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">.venv</span><span class="kw">)</span> <span class="ex">$</span> pip install <span class="at">--upgrade</span> <span class="st">&quot;sphinx[test]==3.4.3&quot;</span> <span class="st">&quot;jinja2&lt;3.0.0&quot;</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">.venv</span><span class="kw">)</span> <span class="ex">$</span> python3.7 <span class="at">-c</span> <span class="st">&quot;import sphinx.testing.fixtures&quot;</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Traceback</span> <span class="er">(</span><span class="ex">most</span> recent call last<span class="kw">)</span><span class="bu">:</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>   <span class="ex">...</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">File</span> <span class="st">&quot;.../.venv/lib/python3.7/site-packages/jinja2/filters.py&quot;</span>, line 13, in <span class="op">&lt;</span>module<span class="op">&gt;</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">from</span> markupsafe import soft_unicode</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a><span class="ex">ImportError:</span> cannot import name <span class="st">&#39;soft_unicode&#39;</span> from <span class="st">&#39;markupsafe&#39;</span> <span class="er">(</span><span class="ex">.../.venv/lib/python3.7/site-packages/markupsafe/__init__.py</span><span class="kw">)</span></span></code></pre></div>
<p>… and, if <code>jinja2&lt;3.0.0</code>, then we need
<code>markupsafe&lt;2.1.0</code>.</p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">.venv</span><span class="kw">)</span> <span class="ex">$</span> pip install <span class="at">--upgrade</span> <span class="st">&quot;sphinx[test]==3.4.3&quot;</span> <span class="st">&quot;jinja2&lt;3.0.0&quot;</span> <span class="st">&quot;markupsafe&lt;2.1.0&quot;</span></span></code></pre></div>
<p>Of course, I only want to do this if the user insists on installing
<code>sphinx&lt;=3.4.3</code>. I have no idea how to do this, or even if
it is possible.</p></li>
</ul>
<p>My current resolution is that I should simply not try to provide such
backwards compatibility in python. If someone needs this, they can
install older versions of my packages, (hopefully they have a lock file
with all of the appropriate dependencies), and moving forward, I just
use lower bound constraints. Of course, with such a change, I would
release a new minor version, and indicate clearly in the change log
which versions are no longer supported.</p></li>
</ul>
<p>. ## PDM</p>
<p>We currently <a href="https://pdm.fming.dev/latest/">PDM</a> for
managing the dependencies. Pure python dependencies should be specified
in the <a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata"><code>pyproject.toml</code></a>
file, whose format is discussed here:</p>
<ul>
<li><a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata/">Declaring
project metadata (from PEP 621)</a></li>
<li>[<code>pyproject,toml</code>][]</li>
</ul>
<h3 id="issues">Issues</h3>
<p>Although <a href="https://pdm.fming.dev/latest/">PDM</a> is possibly
the best current option, there are still many unresolved issues as of
March 2023:</p>
<ul>
<li><a href="https://github.com/pdm-project/pdm/issues/46">#46:
Dependencies get overriden when there are multiple versions of different
markers</a>: This explains why it is so hard to support multiple
versions of python.</li>
</ul>
<h2 id="poetry">Poetry</h2>
<p>DEPRECATED: We no longer use <a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
for several reasons, preferring <a
href="https://pdm.fming.dev/latest/">PDM</a> instead:</p>
<ol type="1">
<li>They strongly advocate using upper bound constraints, we causes real
problems. See Henry Schreiner’s discussion <a
href="https://iscinumpy.dev/post/bound-version-constraints/">Should You
Use Upper Bound Version Constraints</a> for a nice discussion.</li>
<li>They do not follow the standards, so the
[<code>pyproject,toml</code>][] file they generate is not
compliant.</li>
</ol>
<ul>
<li><p>TL;DR: With the current project, you can do all of this with:</p>
<div class="sourceCode" id="cb80"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> dev</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> shell</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div>
<p>System installs will take less disk space and time though.</p></li>
</ul>
<p><a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
has great promise, but is currently a bit of a pain due to some
unresolved issues. Here are some recommendations:</p>
<ul>
<li><p>Always work in an explicit environment. This is an issue if you
routinely have a <a href="https://docs.conda.io" title="Conda">conda</a>
environment activated. Currently, <a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">poetry</a>
interprets an active <a href="https://docs.conda.io"
title="Conda">conda</a> environment as a virtual environment and uses
it. This means that <code>poetry add ...</code> will add these
dependencies <strong>to that environment</strong>. Instead, I <a
href="https://github.com/python-poetry/poetry/issues/1724#issuecomment-834080057">recommend
the following</a>:</p>
<ol type="1">
<li><p>Provide a set of python interpreters at the system level. By
<em>system</em> I mean that you should install these as a special user
(<code>conda</code> or <code>admin</code>) so that users cannot
accidentally install packages into these environments. There are several
ways of doing this. Once these interpreters are available in
<code>PATH</code>, then <a href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">Nox</a> will find them and create
a virtual environment with the appropriate interpreter for testing.</p>
<p>I used to used <a href="https://docs.conda.io"
title="Conda">conda</a>, which is probably a good strategy on Linux
systems etc., but on my Mac M1 Max (ARM), I use <a
href="https://www.macports.org/">MacPorts</a>. This step <em>(only needs
to be done once per system)</em>. <a
href="https://github.com/pyenv/pyenv"
title="Simple Python Version Management: pyenv">PyEnv</a> might be
another option, but I have had problems on my Mac OS X (see above).</p>
<p>Here is an example with <a href="https://docs.conda.io"
title="Conda">conda</a>:</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> py_ver <span class="kw">in</span> 3.7 3.8 3.9 3.10 3.11<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>     <span class="va">conda_env</span><span class="op">=</span><span class="st">&quot;py</span><span class="va">${py_ver}</span><span class="st">&quot;</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">conda</span> create <span class="at">--strict-channel-priority</span> <span class="dt">\</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">-c</span> defaults <span class="at">-y</span>            <span class="dt">\</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">-n</span> <span class="st">&quot;</span><span class="va">${conda_env}</span><span class="st">&quot;</span>         <span class="dt">\ </span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>                  <span class="va">python</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${py_ver}</span><span class="st">&quot;</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>     <span class="ex">conda</span> activate <span class="st">&quot;</span><span class="va">${conda_env}</span><span class="st">&quot;</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ln</span> <span class="at">-fs</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">type</span> <span class="at">-p</span> python<span class="va">${py_ver})</span><span class="st">&quot;</span> ~/.local/bin/</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>     <span class="ex">conda</span> deactivate</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a> <span class="cf">done</span></span></code></pre></div>
<p>Or, using <a href="https://www.macports.org/">MacPorts</a>:</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="ex">port</span> install python37 python38 python39 python310 python311</span></code></pre></div>
<p>Note: these are all native interpreters, meaning that on my Mac M1,
they are ARM executables. In some cases, you might need OSX-64
executables to be run under <a
href="https://support.apple.com/en-us/HT211861">Rosetta</a>. Currently I
need this to install <a
href="https://github.com/pyFFTW/pyFFTW">PyFFTW</a> (see <a
href="https://github.com/pyFFTW/pyFFTW/issues/144">issue #144</a>). This
is more complicated, and so I provide a <code>Makefile</code> that does
this if you run</p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> envs</span></code></pre></div>
<p>This uses <a href="https://docs.conda.io" title="Conda">conda</a>
like above, but also specifies the appropriate architecture (via
<code>CONDA_SUBDIR</code> or the <code>subdir</code> config variable)
and then links these to <code>build/bin</code> which can then be added
to the path. This is also done in <code>noxfile.py</code> if executed on
an Mac OS X ARM platform.</p></li>
<li><p>Specifically activate one of these for each project while
developing <em>(only needs to be done once per project)</em>:</p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> project</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> env use python3.9</span></code></pre></div></li>
<li><p>Poetry should now remember this and use it. See also
<code>poetry env list</code> to see all environments, and
<code>poetry env remove 3.8</code> to remove the environment.</p>
<details>
<p>Prior to creating the virtual environment with
<code>poetry env using</code>, poetry assumes that the conda
<code>work</code> environment is the virtual env:</p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd project</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry env info</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Virtualenv</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Python:</span>         3.8.8</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Implementation:</span> CPython</span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Path:</span>           /data/apps/conda/envs/work</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Valid:</span>          True</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a><span class="ex">System</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Platform:</span> darwin</span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="ex">OS:</span>       posix</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="ex">Python:</span>   /data/apps/conda/envs/work</span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry env using 3.8</span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry env info</span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a><span class="ex">Virtualenv</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a><span class="ex">Python:</span>         3.8.8</span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Implementation:</span> CPython</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a><span class="ex">Path:</span>           .../Caches/pypoetry/virtualenvs/project-...-py3.8</span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a><span class="ex">Valid:</span>          True</span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a><span class="ex">System</span></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a><span class="ex">Platform:</span> darwin</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a><span class="ex">OS:</span>       posix</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a><span class="ex">Python:</span>   /data/apps/conda/envs/work</span></code></pre></div>
</details></li>
</ol></li>
<li><p>To support multiple versions of python, use
<code>python = "^2.7 || ^3.6"</code> for example, with logical or
<code>||</code> not a comma <code>,</code>. Note, however, that poetry
has difficulty resolving dependencies when you have multiple version
specified. You may have to first add your dependencies with each
explicit version. Sometimes I just activate a shell and use
<code>pip</code> to see what it brings. Here is a strategy (I did this
with the [<code>persist</code>][] package):</p>
<ol type="1">
<li><p>Start with your desired python versions, then add projects, and
restrict until everything works:</p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry env use 3.8</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co"># python = &quot;^3.6&quot;</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry add zope.interface importlib-metadata</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> version ^5.4.0 for zope.interface</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> version ^4.0.1 for importlib-metadata</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry add <span class="at">--optional</span> Sphinx pytest pytest-cov sphinx-rtd-theme <span class="dt">\</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>  sphinxcontrib-zopeext nbsphinx h5py mmf-setup scipy</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> version ^3.5.4 for Sphinx</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SolverProblemError</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">For</span> scipy, a possible solution would be to set the <span class="kw">`</span><span class="ex">python</span><span class="kw">`</span> property to <span class="st">&quot;&gt;=3.8,&lt;3.10&quot;</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Try with python = &quot;&gt;=3.8,&lt;3.10&quot;... it works.  Now relax scipy as:</span></span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a><span class="co"># scipy = [</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     {version = &quot;*&quot;, python=&quot;&lt;3.8&quot;, optional = true},</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     {version = &quot;^1.6.3&quot;, python=&quot;^3.8, &lt;3.10&quot;, optional = true}]</span></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a><span class="co"># and try again with python = &quot;^3.6&quot;</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry update</span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SolverProblemError</span></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>  <span class="ex">For</span> h5py, a possible solution would be to set the <span class="kw">`</span><span class="ex">python</span><span class="kw">`</span> property to <span class="st">&quot;&gt;=3.7,&lt;4.0&quot;</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Try with python = &quot;&gt;=3.8,&lt;3.10&quot;... it works.  Now relax scipy as:</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a><span class="co"># h5py = [</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     {version = &quot;*&quot;, python=&quot;&lt;3.7&quot;, optional = true},</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     {version = &quot;^3.2.1&quot;, python=&quot;^3.7&quot;, optional = true}]</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry update </span></code></pre></div></li>
</ol></li>
<li><p>To update packages, us the <code>poetry show</code> command:</p>
<div class="sourceCode" id="cb87"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> show <span class="at">--outdated</span></span></code></pre></div>
<p>Note: it is useful to do this with two separate environments – one at
the lowest version supported, and another at the highest.</p></li>
</ul>
<h2 id="soft-dependencies">Soft Dependencies</h2>
<p>In general, <a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
advocates <a
href="https://python-poetry.org/docs/faq/#why-are-unbound-version-constraints-a-bad-idea">against
unbound versions</a>. While we generally agree, we we really don’t want
installing <code>mmfutils</code> to break their environment because they
need a new version of <a href="https://scipy.org/">SciPy</a> that we
have not had a chance to test yet.</p>
<p>We follow the approach here that <code>mmfutils</code> depends
explicitly on the minimum requirements. Ideally, we would run a set of
tests in an intelligent manner, slowly expanding the range of allowed
versions until we get the broadest range of dependencies that work with
each version of python. However, it might be better to just exclude
known bad-versions, and be otherwise unbound. See also this
discussion:</p>
<ul>
<li><a
href="https://github.com/python-poetry/poetry/issues/7051">Support for
“soft” or suggestet constraints</a></li>
</ul>
<p>All other dependencies – especially complex ones that might break an
install – are optional. Thus, one can still install it without <a
href="https://github.com/pyFFTW/pyFFTW">PyFFTW</a> – which might not be
available on your platform – and still use other features. To support
this, we do the following:</p>
<ul>
<li><p>Delay imports. Thus, <code>import mmfutils.contexts</code> does
not import <code>mmfutils.plot</code>, so one can still use the useful
<code>mmfutils.contexts.FPS</code> without installing
<code>matplotlib</code>. In some cases, the import might be delayed
until a specific function is called, but this should be done
sparingly.</p></li>
<li><p>Make the associated dependencies optional. If the user wants a
fully-functional installation, they do</p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install mmfutils[all]</span></code></pre></div>
<p>This will pull in a working version of <a
href="https://github.com/pyFFTW/pyFFTW">PyFFTW</a>, <a
href="https://scipy.org/">SciPy</a>, etc.</p></li>
</ul>
<h2 id="issues-1">Issues:</h2>
<ul>
<li><a href="https://github.com/python-poetry/poetry/issues/1724"><img
src="https://img.shields.io/github/issues/detail/state/python-poetry/poetry/1724"
alt="Issue" /></a> “Document use of current conda env”</li>
</ul>
<h2 id="references-2">References</h2>
<h1 id="testing-2">Testing</h1>
<p>We generally use <a href="https://nox.thea.codes/en/stable/"
title="Nox: Flexible test automation">Nox</a> for testing since this
provides a way of testing against multiple versions of python. For more
complicated systems, we provide a set of tools in
<code>noxutils.py</code> inspired by the <a
href="https://github.com/brechtm/rinohtype">rinohtype</a> <a
href="https://github.com/brechtm/rinohtype/blob/master/noxutil.py"><code>noxutil.py</code></a>
file which provides a list of versions that might be installed.</p>
<h2 id="issues-2">Issues:</h2>
<ul>
<li>It would be really nice if <code>noxutils.py</code> did not require
<a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
as an install and could get the appropriate information directly by
invoking <code>poetry</code>, which might be installed outside of the
development environment.</li>
<li>Related to the above, it would be really nice if there were a
semi-automated way of determining the widest dependency requirements
with tests. Something like: run tests with extreme versions of various
libraries, bisecting to find boundaries.</li>
</ul>
<h1 id="github">GitHub</h1>
<p><a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">Poetry</a>
has great promise, but is currently a bit of a pain due to some
unresolved issues. Here are some recommendations:</p>
<ul>
<li><p>Always work in an explicit environment. This is an issue if you
routinely have a <a href="https://docs.conda.io" title="Conda">conda</a>
environment activated. Currently, <a href="https://poetry.eustace.io"
title="Python packaging and dependency management made easy.">poetry</a>
interprets an active <a href="https://docs.conda.io"
title="Conda">conda</a> environment as a virtual environment and uses
it. This means that <code>poetry add ...</code> will add these
dependencies <strong>to that environment</strong>. Instead, I <a
href="https://github.com/python-poetry/poetry/issues/1724#issuecomment-834080057">recommend
the following</a>:</p>
<ol type="1">
<li><p>Create some bare <a href="https://docs.conda.io"
title="Conda">conda</a> environments with the various python
interpreters you want to use <em>(only needs to be done once per
system)</em>:</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> py_ver <span class="kw">in</span> 2.7 3.6 3.7 3.8 3.9<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>     <span class="va">conda_env</span><span class="op">=</span><span class="st">&quot;py</span><span class="va">${py_ver}</span><span class="st">&quot;</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>     <span class="ex">conda</span> create <span class="at">--strict-channel-priority</span> <span class="dt">\</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">-c</span> defaults <span class="at">-y</span>            <span class="dt">\</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">-n</span> <span class="st">&quot;</span><span class="va">${conda_env}</span><span class="st">&quot;</span>         <span class="dt">\ </span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>                  <span class="va">python</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${py_ver}</span><span class="st">&quot;</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>     <span class="ex">conda</span> activate <span class="st">&quot;</span><span class="va">${conda_env}</span><span class="st">&quot;</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>     <span class="fu">ln</span> <span class="at">-fs</span> <span class="st">&quot;</span><span class="va">$(</span><span class="bu">type</span> <span class="at">-p</span> python<span class="va">${py_ver})</span><span class="st">&quot;</span> ~/.local/bin/</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>     <span class="ex">conda</span> deactivate</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a> <span class="cf">done</span></span></code></pre></div></li>
<li><p>Specifically activate one of these for each project while
developing <em>(only needs to be done once per project)</em>:</p>
<div class="sourceCode" id="cb90"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> project</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="ex">poetry</span> env use python3.8</span></code></pre></div></li>
<li><p>Poetry should now remember this and use it. See also
<code>poetry env list</code> to see all environments, and
<code>poetry env remove 3.8</code> to remove the environment.</p>
<details>
<p>Prior to creating the virtual environment with
<code>poetry env using</code>, poetry assumes that the conda
<code>work</code> environment is the virtual env:</p>
<div class="sourceCode" id="cb91"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd project</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry env info</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Virtualenv</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Python:</span>         3.8.8</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Implementation:</span> CPython</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Path:</span>           /data/apps/conda/envs/work</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Valid:</span>          True</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="ex">System</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Platform:</span> darwin</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="ex">OS:</span>       posix</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="ex">Python:</span>   /data/apps/conda/envs/work</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry env using 3.8</span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry env info</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a><span class="ex">Virtualenv</span></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a><span class="ex">Python:</span>         3.8.8</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Implementation:</span> CPython</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a><span class="ex">Path:</span>           .../Caches/pypoetry/virtualenvs/project-...-py3.8</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a><span class="ex">Valid:</span>          True</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a><span class="ex">System</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a><span class="ex">Platform:</span> darwin</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a><span class="ex">OS:</span>       posix</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a><span class="ex">Python:</span>   /data/apps/conda/envs/work</span></code></pre></div>
</details></li>
</ol></li>
<li><p>To support multiple versions of python, use
<code>python = "^2.7 || ^3.6"</code> for example, with logical or
<code>||</code> not a comma <code>,</code>. Note, however, that poetry
has difficulty resolving dependencies when you have multiple version
specified. You may have to first add your dependencies with each
explicit version. Sometimes I just activate a shell and use
<code>pip</code> to see what it brings. Here is a strategy (I did this
with the [<code>persist</code>][] package):</p>
<ol type="1">
<li><p>Start with your desired python versions, then add projects, and
restrict until everything works:</p>
<div class="sourceCode" id="cb92"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry env use 3.8</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="co"># python = &quot;^3.6&quot;</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry add zope.interface importlib-metadata</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> version ^5.4.0 for zope.interface</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> version ^4.0.1 for importlib-metadata</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry add <span class="at">--optional</span> Sphinx pytest pytest-cov sphinx-rtd-theme <span class="dt">\</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>  sphinxcontrib-zopeext nbsphinx h5py mmf-setup scipy</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> version ^3.5.4 for Sphinx</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SolverProblemError</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">For</span> scipy, a possible solution would be to set the <span class="kw">`</span><span class="ex">python</span><span class="kw">`</span> property to <span class="st">&quot;&gt;=3.8,&lt;3.10&quot;</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Try with python = &quot;&gt;=3.8,&lt;3.10&quot;... it works.  Now relax scipy as:</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="co"># scipy = [</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     {version = &quot;*&quot;, python=&quot;&lt;3.8&quot;, optional = true},</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     {version = &quot;^1.6.3&quot;, python=&quot;^3.8, &lt;3.10&quot;, optional = true}]</span></span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a><span class="co"># and try again with python = &quot;^3.6&quot;</span></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry update</span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SolverProblemError</span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>  <span class="ex">For</span> h5py, a possible solution would be to set the <span class="kw">`</span><span class="ex">python</span><span class="kw">`</span> property to <span class="st">&quot;&gt;=3.7,&lt;4.0&quot;</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Try with python = &quot;&gt;=3.8,&lt;3.10&quot;... it works.  Now relax scipy as:</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a><span class="co"># h5py = [</span></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     {version = &quot;*&quot;, python=&quot;&lt;3.7&quot;, optional = true},</span></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     {version = &quot;^3.2.1&quot;, python=&quot;^3.7&quot;, optional = true}]</span></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry update </span></code></pre></div>
<p>Note: Be very careful to express complete constraints. The following
works</p>
<p>Consider both sides of the suggested dependencies. Once I relaxed the
requirements for scipy for <code>python="&lt;3.8"</code> I still got
errors saying</p></li>
<li><p>Add all dependencies and see what happens:</p>
<div class="sourceCode" id="cb93"><pre
class="sourceCode bash"><code class="sourceCode bash"></code></pre></div></li>
</ol></li>
<li><p>If you only need a tool for development, you can add it with the
<code>-D</code> flag. Note: if you get an error about the version of
python required here, you can simply avoid this by specifying a more
specific version required for installing the dev tools. For example:</p>
<div class="sourceCode" id="cb94"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry add <span class="at">-D</span> ipython</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">SolverProblemError</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">-</span> ipython requires Python <span class="op">&gt;</span>=3.7</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> poetry add <span class="at">-D</span> ipython <span class="at">--python</span> <span class="st">&#39;^3.7&#39;</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Using</span> version ^7.24.1 for ipython</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div></li>
</ul>
<h1 id="issues-3">Issues:</h1>
<h2 id="pyfftw">pyFFTW</h2>
<p><strong>TL;DR</strong> Until several issues are fixed, use the
following source to install pyFFTW:</p>
<pre><code>PYFFTW_REPO=&quot;git+https://github.com/karlotness/pyFFTW.git@linker-flags&quot;
python3 -m pip install -v --no-cache &quot;${PYFFTW_REPO}&quot;</code></pre>
<p>I was having lots of issues with <a
href="https://github.com/pyFFTW/pyFFTW">pyFFTW</a> on my ARM Mac. These
include the following:</p>
<ul>
<li><p>Poor performance - comparable or worse than NumPy. This typically
happens when the incorrect FFTW library is found: i.e. if you have an
incompatible or poorly built version in an active Conda environment when
you build. Generally we recommend installing <code>fftw</code> from
<code>conda-forge</code>, but if you have bad performance, you might
need to recompile yourself. See for example <a
href="https://github.com/conda-forge/fftw-feedstock/issues/94">fftw-feedstock
issue #94</a> and <a
href="https://github.com/FFTW/fftw3/issues/129">fftw issue #129</a>
which affected ARM platforms like the Mac OS X M1 chip.</p>
<details>
<p>To install the <a href="https://www.fftw.org/">FFTW</a> on my Mac, I
downloaded the source, then ran (as <code>admin</code>):</p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="va">MY_FLAGS</span><span class="op">=</span><span class="st">&quot;--enable-threads --enable-armv8-cntvct-el0 --prefix=/data/apps/fftw/3.3.10&quot;</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span> <span class="at">--enable-float</span> <span class="va">$MY_FLAGS</span> </span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> <span class="at">-j8</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="ex">./configure</span> <span class="va">$MY_FLAGS</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> <span class="at">-j8</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> install</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a><span class="fu">make</span> clean</span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="bu">pushd</span> /data/apps/fftw/ <span class="kw">&amp;&amp;</span> <span class="fu">ln</span> <span class="at">-s</span> 3.3.10 current <span class="kw">&amp;&amp;</span> <span class="bu">popd</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mkdir <span class="at">-p</span> /usr/local/lib</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mkdir <span class="at">-p</span> /usr/local/bin</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> mkdir <span class="at">-p</span> /usr/local/include</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /data/apps/fftw/current/lib/<span class="pp">*</span> /usr/local/lib/</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /data/apps/fftw/current/include/<span class="pp">*</span> /usr/local/include/</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> ln <span class="at">-s</span> /data/apps/fftw/current/bin/<span class="pp">*</span> /usr/local/bin/</span></code></pre></div>
<p>This installs the float and double precision versions in
<code>/data/apps/fftw/3.3.10</code> which I then symlink to
<code>/usr/local/lib</code>. Note that ARM’s do not have a separate long
double, so the <code>fftwl</code> library is not built here.</p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Custom compile of pyfftw</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python testfftw.py </span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="va">Nxyz</span><span class="op">=</span><span class="va">(</span>2, 64<span class="va">)</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="ex">np</span>    : 0.0014s <span class="er">(</span><span class="ex">median</span> 0.0014s<span class="kw">)</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0216s <span class="er">(</span><span class="ex">median</span> 0.0216s<span class="kw">)</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="va">Nxyz</span><span class="op">=</span><span class="va">(</span>1200, 1200<span class="va">)</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a><span class="ex">np</span>    : 0.2019s <span class="er">(</span><span class="ex">median</span> 0.2028s<span class="kw">)</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0821s <span class="er">(</span><span class="ex">median</span> 0.0824s<span class="kw">)</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a><span class="va">Nxyz</span><span class="op">=</span><span class="va">(</span>256, 256, 256<span class="va">)</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="ex">np</span>    : 0.0696s <span class="er">(</span><span class="ex">median</span> 0.0727s<span class="kw">)</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0326s <span class="er">(</span><span class="ex">median</span> 0.0332s<span class="kw">)</span></span></code></pre></div>
<div class="sourceCode" id="cb98"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># With conda-forge verions of pyfftw</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python testfftw.py </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="va">Nxyz</span><span class="op">=</span><span class="va">(</span>2, 64<span class="va">)</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="ex">np</span>    : 0.0015s <span class="er">(</span><span class="ex">median</span> 0.0015s<span class="kw">)</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0187s <span class="er">(</span><span class="ex">median</span> 0.0187s<span class="kw">)</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="va">Nxyz</span><span class="op">=</span><span class="va">(</span>1200, 1200<span class="va">)</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="ex">np</span>    : 0.2050s <span class="er">(</span><span class="ex">median</span> 0.2060s<span class="kw">)</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0812s <span class="er">(</span><span class="ex">median</span> 0.0817s<span class="kw">)</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a><span class="va">Nxyz</span><span class="op">=</span><span class="va">(</span>256, 256, 256<span class="va">)</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="ex">np</span>    : 0.0698s <span class="er">(</span><span class="ex">median</span> 0.0698s<span class="kw">)</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0952s <span class="er">(</span><span class="ex">median</span> 0.0984s<span class="kw">)</span></span></code></pre></div>
<div class="sourceCode" id="cb99"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co"># With conda-forge verions of pyfftw but forced recompile of pyfftw from source.</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python testfftw.py</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="va">Nxyz</span><span class="op">=</span><span class="va">(</span>2, 64<span class="va">)</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="ex">np</span>    : 0.0014s <span class="er">(</span><span class="ex">median</span> 0.0014s<span class="kw">)</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0202s <span class="er">(</span><span class="ex">median</span> 0.0204s<span class="kw">)</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a><span class="va">Nxyz</span><span class="op">=</span><span class="va">(</span>1200, 1200<span class="va">)</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="ex">np</span>    : 0.1841s <span class="er">(</span><span class="ex">median</span> 0.1844s<span class="kw">)</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0704s <span class="er">(</span><span class="ex">median</span> 0.0740s<span class="kw">)</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="va">Nxyz</span><span class="op">=</span><span class="va">(</span>256, 256, 256<span class="va">)</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="ex">np</span>    : 0.0701s <span class="er">(</span><span class="ex">median</span> 0.0723s<span class="kw">)</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0335s <span class="er">(</span><span class="ex">median</span> 0.0344s<span class="kw">)</span></span></code></pre></div>
<p>I use the following code to test:</p>
<div class="sourceCode" id="cb100"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># testfftw.py</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os, time, timeit, numpy <span class="im">as</span> np, pyfftw.builders</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(seed<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> Nxyz <span class="kw">in</span> [(<span class="dv">2</span>, <span class="dv">64</span>), (<span class="dv">1200</span>,) <span class="op">*</span> <span class="dv">2</span>, (<span class="dv">256</span>,) <span class="op">*</span> <span class="dv">3</span>]:</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>Nxyz<span class="op">=</span><span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    psi <span class="op">=</span> rng.normal(size<span class="op">=</span>Nxyz) <span class="op">+</span> rng.normal(size<span class="op">=</span>Nxyz) <span class="op">*</span> <span class="ot">1j</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>    tic <span class="op">=</span> time.time()</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    psi_t <span class="op">=</span> np.fft.fftn(psi)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>    t <span class="op">=</span> time.time() <span class="op">-</span> tic</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>    T, repeat <span class="op">=</span> <span class="dv">3</span>, <span class="dv">5</span>  <span class="co"># Desired time for tests in s and number of repeats</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    number <span class="op">=</span> <span class="bu">max</span>(<span class="dv">1</span>, <span class="bu">int</span>(T <span class="op">/</span> t <span class="op">/</span> repeat))</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> test(fftn, label<span class="op">=</span><span class="st">&quot;&quot;</span>):</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>        ts <span class="op">=</span> timeit.repeat(</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;fftn(psi)&quot;</span>, <span class="bu">globals</span><span class="op">=</span><span class="bu">dict</span>(psi<span class="op">=</span>psi, fftn<span class="op">=</span>fftn), repeat<span class="op">=</span>repeat, number<span class="op">=</span>number</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>label<span class="sc">:6}</span><span class="ss">: </span><span class="sc">{</span><span class="bu">min</span>(ts)<span class="sc">:.4f}</span><span class="ss">s (median </span><span class="sc">{</span>np<span class="sc">.</span>median(ts)<span class="sc">:.4f}</span><span class="ss">s)&quot;</span>)</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>    test(np.fft.fft, <span class="st">&quot;np&quot;</span>)</span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>    fftn <span class="op">=</span> pyfftw.builders.fftn(</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>        psi.copy(), threads<span class="op">=</span>os.cpu_count(), planner_effort<span class="op">=</span><span class="st">&quot;FFTW_MEASURE&quot;</span></span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> np.allclose(fftn(psi), psi_t)</span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>    test(fftn, <span class="st">&quot;pyfftw&quot;</span>)</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>()</span></code></pre></div>
<p>The second number should be significantly smaller. For example, with
a custom built <a href="https://www.fftw.org/">FFTW</a> library on my
Mac OS M1 Max, building <a
href="https://github.com/pyFFTW/pyFFTW">pyFFTW</a> from source (see
below), I have (complex double transforms):</p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python testfftw.py </span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="ex">np:</span> 0.0214s</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="ex">pyfftw:</span> 0.0027s</span></code></pre></div></li>
<li><p>Several new issues related to Cython 3.0 appeared in 2023: <a
href="https://github.com/pyFFTW/pyFFTW/issues/362">issue #362</a> and <a
href="https://github.com/pyFFTW/pyFFTW/issues/294">issue #294</a>, and
several related to paths <a
href="https://github.com/pyFFT/pyFFTW/issues/349">issue #349</a> and <a
href="https://github.com/pyFFTW/pyFFTW/issues/352">issue #352</a>. Most
of these seem to be resolved by <a
href="https://github.com/pyFFTW/pyFFTW/pull/363">PR #363</a>, so I
currently recommend using that.</p></li>
<li><p>Consider <code>pyFFTW</code>: if not using <a
href="https://docs.conda.io" title="Conda">Conda</a>, then this needs
the FFTW libraries installed on the host platform, otherwise the install
will fail. How best to deal with this? My current solution is to provide
these as extras, but it would be nice if there was a way to install if
the libraries are present.</p></li>
<li><p><code>error: Could not find any of the FFTW libraries</code>:
this was mostly related to <a
href="https://github.com/pyFFTW/pyFFTW/issues/303">issue #303</a> which
is now fixed on <code>master</code>. Until this is release, one can
install from source:</p>
<div class="sourceCode" id="cb102"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install git+https://github.com/pyFFTW/pyFFTW.git</span></code></pre></div>
<p>As for <a href="https://github.com/pyFFTW/pyFFTW/issues/303">issue
#303</a>, here is what changed:
https://github.com/pyFFTW/pyFFTW/compare/v0.13.1..master. You can
probably fix this by specifying
<code>-Werror=implicit-function-declaration</code> somehow in your
compiler flags.</p>
<p>Here is a typical example failure:</p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="ex">micromamba</span> create <span class="at">-y</span> <span class="at">-c</span> defaults <span class="at">-p</span> envs/py3.11 python=3.11 fftw numpy Cython</span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="bu">eval</span> <span class="st">&quot;</span><span class="va">$(</span><span class="ex">micromamba</span> shell hook <span class="at">--shell</span><span class="op">=</span>bash<span class="va">)</span><span class="st">&quot;</span> <span class="kw">&amp;&amp;</span> <span class="ex">micromamba</span> activate envs/py3.11</span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a><span class="ex">python3</span> <span class="at">-m</span> pip install <span class="at">--no-cache</span> <span class="st">&quot;pyfftw==0.13.1&quot;</span></span></code></pre></div>
<details>
<div class="sourceCode" id="cb104"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> micromamba create <span class="at">-y</span> <span class="at">-c</span> defaults <span class="at">-p</span> envs/py3.11 python=3.11 fftw numpy</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>                                           <span class="ex">__</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>          <span class="ex">__</span>  ______ ___  ____ _____ ___  / /_  ____ _</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>         <span class="ex">/</span> / / / __ <span class="kw">`</span><span class="ex">__</span> <span class="dt">\/</span> __ <span class="kw">`</span>/ __ <span class="kw">`</span><span class="ex">__</span> <span class="dt">\/</span> __ <span class="dt">\/</span> __ <span class="kw">`</span>/</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>        <span class="ex">/</span> /_/ / / / / / / /_/ / / / / / / /_/ / /_/ /</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>       <span class="ex">/</span> .___/_/ /_/ /_/\__,_/_/ /_/ /_/_.___/\__,_/</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>      <span class="ex">/_/</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a><span class="ex">pkgs/main/noarch</span>                                              No change</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a><span class="ex">pkgs/r/noarch</span>                                                 No change</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a><span class="ex">pkgs/r/osx-arm64</span>                                              No change</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="ex">pkgs/main/osx-arm64</span>                                           No change</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Transaction</span></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Prefix:</span> .../py3.11</span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Updating</span> specs:</span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a>   <span class="ex">-</span> python=3.11</span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>   <span class="ex">-</span> fftw</span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>   <span class="ex">-</span> numpy</span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Package</span>               Version  Build               Channel         Size</span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a><span class="ex">───────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Install:</span></span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a><span class="ex">───────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> blas                    1.0  openblas            pkgs/main     Cached</span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> bzip2                 1.0.8  h620ffc9_4          pkgs/main     Cached</span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> ca-certificates  2023.05.30  hca03da5_0          pkgs/main     Cached</span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> fftw                  3.3.9  h1a28f6b_1          pkgs/main     Cached</span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> libcxx               14.0.6  h848a8c0_0          pkgs/main     Cached</span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> libffi                3.4.4  hca03da5_0          pkgs/main     Cached</span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> libgfortran           5.0.0  11_3_0_hca03da5_28  pkgs/main     Cached</span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> libgfortran5         11.3.0  h009349e_28         pkgs/main     Cached</span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> libopenblas          0.3.21  h269037a_0          pkgs/main     Cached</span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> llvm-openmp          14.0.6  hc6e5704_0          pkgs/main     Cached</span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> ncurses                 6.4  h313beb8_0          pkgs/main     Cached</span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> numpy                1.24.3  py311hb57d4eb_0     pkgs/main     Cached</span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> numpy-base           1.24.3  py311h1d85a46_0     pkgs/main     Cached</span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> openssl               3.0.8  h1a28f6b_0          pkgs/main     Cached</span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> pip                  23.1.2  py311hca03da5_0     pkgs/main     Cached</span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> python               3.11.3  hb885b13_1          pkgs/main     Cached</span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> readline                8.2  h1a28f6b_0          pkgs/main     Cached</span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> setuptools           67.8.0  py311hca03da5_0     pkgs/main     Cached</span>
<span id="cb104-49"><a href="#cb104-49" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> sqlite               3.41.2  h80987f9_0          pkgs/main     Cached</span>
<span id="cb104-50"><a href="#cb104-50" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> tk                   8.6.12  hb8d0fd4_0          pkgs/main     Cached</span>
<span id="cb104-51"><a href="#cb104-51" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> tzdata                2023c  h04d1e81_0          pkgs/main     Cached</span>
<span id="cb104-52"><a href="#cb104-52" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> wheel                0.38.4  py311hca03da5_0     pkgs/main     Cached</span>
<span id="cb104-53"><a href="#cb104-53" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> xz                    5.4.2  h80987f9_0          pkgs/main     Cached</span>
<span id="cb104-54"><a href="#cb104-54" aria-hidden="true" tabindex="-1"></a>  <span class="ex">+</span> zlib                 1.2.13  h5a0b063_0          pkgs/main     Cached</span>
<span id="cb104-55"><a href="#cb104-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-56"><a href="#cb104-56" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Summary:</span></span>
<span id="cb104-57"><a href="#cb104-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-58"><a href="#cb104-58" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Install:</span> 24 packages</span>
<span id="cb104-59"><a href="#cb104-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-60"><a href="#cb104-60" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Total</span> download: 0 B</span>
<span id="cb104-61"><a href="#cb104-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-62"><a href="#cb104-62" aria-hidden="true" tabindex="-1"></a><span class="ex">───────────────────────────────────────────────────────────────────────────</span></span>
<span id="cb104-63"><a href="#cb104-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-64"><a href="#cb104-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-65"><a href="#cb104-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-66"><a href="#cb104-66" aria-hidden="true" tabindex="-1"></a><span class="ex">Transaction</span> starting</span>
<span id="cb104-67"><a href="#cb104-67" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> fftw-3.3.9-h1a28f6b_1</span>
<span id="cb104-68"><a href="#cb104-68" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> ncurses-6.4-h313beb8_0</span>
<span id="cb104-69"><a href="#cb104-69" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> xz-5.4.2-h80987f9_0</span>
<span id="cb104-70"><a href="#cb104-70" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> zlib-1.2.13-h5a0b063_0</span>
<span id="cb104-71"><a href="#cb104-71" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> blas-1.0-openblas</span>
<span id="cb104-72"><a href="#cb104-72" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> libcxx-14.0.6-h848a8c0_0</span>
<span id="cb104-73"><a href="#cb104-73" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> bzip2-1.0.8-h620ffc9_4</span>
<span id="cb104-74"><a href="#cb104-74" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> libffi-3.4.4-hca03da5_0</span>
<span id="cb104-75"><a href="#cb104-75" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> ca-certificates-2023.05.30-hca03da5_0</span>
<span id="cb104-76"><a href="#cb104-76" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> llvm-openmp-14.0.6-hc6e5704_0</span>
<span id="cb104-77"><a href="#cb104-77" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> readline-8.2-h1a28f6b_0</span>
<span id="cb104-78"><a href="#cb104-78" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> tk-8.6.12-hb8d0fd4_0</span>
<span id="cb104-79"><a href="#cb104-79" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> openssl-3.0.8-h1a28f6b_0</span>
<span id="cb104-80"><a href="#cb104-80" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> libgfortran5-11.3.0-h009349e_28</span>
<span id="cb104-81"><a href="#cb104-81" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> sqlite-3.41.2-h80987f9_0</span>
<span id="cb104-82"><a href="#cb104-82" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> libgfortran-5.0.0-11_3_0_hca03da5_28</span>
<span id="cb104-83"><a href="#cb104-83" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> libopenblas-0.3.21-h269037a_0</span>
<span id="cb104-84"><a href="#cb104-84" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> tzdata-2023c-h04d1e81_0</span>
<span id="cb104-85"><a href="#cb104-85" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> python-3.11.3-hb885b13_1</span>
<span id="cb104-86"><a href="#cb104-86" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> wheel-0.38.4-py311hca03da5_0</span>
<span id="cb104-87"><a href="#cb104-87" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> setuptools-67.8.0-py311hca03da5_0</span>
<span id="cb104-88"><a href="#cb104-88" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> pip-23.1.2-py311hca03da5_0</span>
<span id="cb104-89"><a href="#cb104-89" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> numpy-base-1.24.3-py311h1d85a46_0</span>
<span id="cb104-90"><a href="#cb104-90" aria-hidden="true" tabindex="-1"></a><span class="ex">Linking</span> numpy-1.24.3-py311hb57d4eb_0</span>
<span id="cb104-91"><a href="#cb104-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-92"><a href="#cb104-92" aria-hidden="true" tabindex="-1"></a><span class="ex">Transaction</span> finished</span>
<span id="cb104-93"><a href="#cb104-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-94"><a href="#cb104-94" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span>
<span id="cb104-95"><a href="#cb104-95" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> eval <span class="st">&quot;</span><span class="va">$(</span><span class="ex">micromamba</span> shell hook <span class="at">--shell</span><span class="op">=</span>bash<span class="va">)</span><span class="st">&quot;</span> <span class="kw">&amp;&amp;</span> <span class="ex">micromamba</span> activate envs/py3.11</span>
<span id="cb104-96"><a href="#cb104-96" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">py3</span><span class="kw">)</span> <span class="ex">$</span> python3 <span class="at">-m</span> pip install <span class="at">--no-cache</span> pyfftw</span>
<span id="cb104-97"><a href="#cb104-97" aria-hidden="true" tabindex="-1"></a><span class="ex">Collecting</span> pyfftw</span>
<span id="cb104-98"><a href="#cb104-98" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Downloading</span> pyFFTW-0.13.1.tar.gz <span class="er">(</span><span class="ex">114</span> kB<span class="kw">)</span></span>
<span id="cb104-99"><a href="#cb104-99" aria-hidden="true" tabindex="-1"></a>     <span class="ex">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</span> 114.4/114.4 kB 1.5 MB/s eta 0:00:00</span>
<span id="cb104-100"><a href="#cb104-100" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Installing</span> build dependencies ... done</span>
<span id="cb104-101"><a href="#cb104-101" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Getting</span> requirements to build wheel ... done</span>
<span id="cb104-102"><a href="#cb104-102" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Preparing</span> metadata <span class="er">(</span><span class="ex">pyproject.toml</span><span class="kw">)</span> <span class="ex">...</span> done</span>
<span id="cb104-103"><a href="#cb104-103" aria-hidden="true" tabindex="-1"></a><span class="ex">Requirement</span> already satisfied: numpy<span class="op">&lt;</span>2.0,<span class="op">&gt;</span>=1.20 in ./envs/py3.11/lib/python3.11/site-packages <span class="er">(</span><span class="ex">from</span> pyfftw<span class="kw">)</span> <span class="kw">(</span><span class="ex">1.24.3</span><span class="kw">)</span></span>
<span id="cb104-104"><a href="#cb104-104" aria-hidden="true" tabindex="-1"></a><span class="ex">Building</span> wheels for collected packages: pyfftw</span>
<span id="cb104-105"><a href="#cb104-105" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Building</span> wheel for pyfftw <span class="er">(</span><span class="ex">pyproject.toml</span><span class="kw">)</span> <span class="ex">...</span> error</span>
<span id="cb104-106"><a href="#cb104-106" aria-hidden="true" tabindex="-1"></a>  <span class="ex">error:</span> subprocess-exited-with-error</span>
<span id="cb104-107"><a href="#cb104-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-108"><a href="#cb104-108" aria-hidden="true" tabindex="-1"></a>  <span class="ex">×</span> Building wheel for pyfftw <span class="er">(</span><span class="ex">pyproject.toml</span><span class="kw">)</span> <span class="ex">did</span> not run successfully.</span>
<span id="cb104-109"><a href="#cb104-109" aria-hidden="true" tabindex="-1"></a>  <span class="ex">│</span> exit code: 1</span>
<span id="cb104-110"><a href="#cb104-110" aria-hidden="true" tabindex="-1"></a>  <span class="ex">╰─</span><span class="op">&gt;</span> [71 lines of output]</span>
<span id="cb104-111"><a href="#cb104-111" aria-hidden="true" tabindex="-1"></a>      <span class="ex">running</span> bdist_wheel</span>
<span id="cb104-112"><a href="#cb104-112" aria-hidden="true" tabindex="-1"></a>      <span class="ex">running</span> build</span>
<span id="cb104-113"><a href="#cb104-113" aria-hidden="true" tabindex="-1"></a>      <span class="ex">running</span> build_py</span>
<span id="cb104-114"><a href="#cb104-114" aria-hidden="true" tabindex="-1"></a>      <span class="ex">creating</span> build</span>
<span id="cb104-115"><a href="#cb104-115" aria-hidden="true" tabindex="-1"></a>      <span class="ex">creating</span> build/lib.macosx-11.1-arm64-3.11</span>
<span id="cb104-116"><a href="#cb104-116" aria-hidden="true" tabindex="-1"></a>      <span class="ex">creating</span> build/lib.macosx-11.1-arm64-3.11/pyfftw</span>
<span id="cb104-117"><a href="#cb104-117" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/config.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw</span>
<span id="cb104-118"><a href="#cb104-118" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/_version.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw</span>
<span id="cb104-119"><a href="#cb104-119" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/__init__.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw</span>
<span id="cb104-120"><a href="#cb104-120" aria-hidden="true" tabindex="-1"></a>      <span class="ex">creating</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/builders</span>
<span id="cb104-121"><a href="#cb104-121" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/builders/builders.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/builders</span>
<span id="cb104-122"><a href="#cb104-122" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/builders/__init__.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/builders</span>
<span id="cb104-123"><a href="#cb104-123" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/builders/_utils.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/builders</span>
<span id="cb104-124"><a href="#cb104-124" aria-hidden="true" tabindex="-1"></a>      <span class="ex">creating</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/interfaces</span>
<span id="cb104-125"><a href="#cb104-125" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/interfaces/cache.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/interfaces</span>
<span id="cb104-126"><a href="#cb104-126" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/interfaces/__init__.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/interfaces</span>
<span id="cb104-127"><a href="#cb104-127" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/interfaces/scipy_fft.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/interfaces</span>
<span id="cb104-128"><a href="#cb104-128" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/interfaces/dask_fft.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/interfaces</span>
<span id="cb104-129"><a href="#cb104-129" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/interfaces/numpy_fft.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/interfaces</span>
<span id="cb104-130"><a href="#cb104-130" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/interfaces/scipy_fftpack.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/interfaces</span>
<span id="cb104-131"><a href="#cb104-131" aria-hidden="true" tabindex="-1"></a>      <span class="ex">copying</span> pyfftw/interfaces/_utils.py <span class="at">-</span><span class="op">&gt;</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/interfaces</span>
<span id="cb104-132"><a href="#cb104-132" aria-hidden="true" tabindex="-1"></a>      <span class="ex">UPDATING</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/_version.py</span>
<span id="cb104-133"><a href="#cb104-133" aria-hidden="true" tabindex="-1"></a>      <span class="bu">set</span> build/lib.macosx-11.1-arm64-3.11/pyfftw/_version.py to <span class="st">&#39;0.13.1&#39;</span></span>
<span id="cb104-134"><a href="#cb104-134" aria-hidden="true" tabindex="-1"></a>      <span class="ex">running</span> build_ext</span>
<span id="cb104-135"><a href="#cb104-135" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:Link</span> FFTW dynamically</span>
<span id="cb104-136"><a href="#cb104-136" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:Compiler</span> include_dirs: [<span class="st">&#39;./envs/py3.11/include/python3.11&#39;</span>]</span>
<span id="cb104-137"><a href="#cb104-137" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:3.11.3</span> <span class="er">(</span><span class="ex">main,</span> May 15 2023, 18:01:31<span class="kw">)</span> <span class="ex">[Clang</span> 14.0.6 ]</span>
<span id="cb104-138"><a href="#cb104-138" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:Sniffer</span> include_dirs: [<span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/include&#39;</span>, <span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/pyfftw&#39;</span>, <span class="st">&#39;/tmp-dir/pip-build-env-jifbhuv5/overlay/lib/python3.11/site-packages/numpy/core/include&#39;</span>, <span class="st">&#39;./envs/py3.11/include&#39;</span>]</span>
<span id="cb104-139"><a href="#cb104-139" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:objects:</span> []</span>
<span id="cb104-140"><a href="#cb104-140" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:libraries:</span> []</span>
<span id="cb104-141"><a href="#cb104-141" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:include</span> dirs: [<span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/include&#39;</span>, <span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/pyfftw&#39;</span>, <span class="st">&#39;/tmp-dir/pip-build-env-jifbhuv5/overlay/lib/python3.11/site-packages/numpy/core/include&#39;</span>, <span class="st">&#39;./envs/py3.11/include&#39;</span>]</span>
<span id="cb104-142"><a href="#cb104-142" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:clang</span> <span class="at">-DNDEBUG</span> <span class="at">-fwrapv</span> <span class="at">-O2</span> <span class="at">-Wall</span> <span class="at">-fPIC</span> <span class="at">-O2</span> <span class="at">-isystem</span> ./envs/py3.11/include <span class="at">-arch</span> arm64 <span class="at">-fPIC</span> <span class="at">-O2</span> <span class="at">-isystem</span> ./envs/py3.11/include <span class="at">-arch</span> arm64 <span class="at">-I</span>/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/include <span class="at">-I</span>/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/pyfftw <span class="at">-I</span>/tmp-dir/pip-build-env-jifbhuv5/overlay/lib/python3.11/site-packages/numpy/core/include <span class="at">-I.</span>/envs/py3.11/include <span class="at">-I.</span>/envs/py3.11/include/python3.11 <span class="at">-c</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-5ht27cq0/None.c <span class="at">-o</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-5ht27cq0/None.o</span>
<span id="cb104-143"><a href="#cb104-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-144"><a href="#cb104-144" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:clang</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-5ht27cq0/None.o <span class="at">-L.</span>/envs/py3.11/lib <span class="at">-o</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-5ht27cq0/a.out</span>
<span id="cb104-145"><a href="#cb104-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-146"><a href="#cb104-146" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:Checking</span> with includes [<span class="st">&#39;fftw3.h&#39;</span>]...ok</span>
<span id="cb104-147"><a href="#cb104-147" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:objects:</span> []</span>
<span id="cb104-148"><a href="#cb104-148" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:libraries:</span> [<span class="st">&#39;fftw3&#39;</span>]</span>
<span id="cb104-149"><a href="#cb104-149" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:include</span> dirs: [<span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/include&#39;</span>, <span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/pyfftw&#39;</span>, <span class="st">&#39;/tmp-dir/pip-build-env-jifbhuv5/overlay/lib/python3.11/site-packages/numpy/core/include&#39;</span>, <span class="st">&#39;./envs/py3.11/include&#39;</span>]</span>
<span id="cb104-150"><a href="#cb104-150" aria-hidden="true" tabindex="-1"></a>      <span class="ex">/var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-hfaar1y4/fftw_plan_dft.c:2:17:</span> error: implicit declaration of function <span class="st">&#39;fftw_plan_dft&#39;</span> is invalid in C99 [-Werror,-Wimplicit-function-declaration]</span>
<span id="cb104-151"><a href="#cb104-151" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">fftw_plan_dft()</span><span class="kw">;</span></span>
<span id="cb104-152"><a href="#cb104-152" aria-hidden="true" tabindex="-1"></a>                      <span class="ex">^</span></span>
<span id="cb104-153"><a href="#cb104-153" aria-hidden="true" tabindex="-1"></a>      <span class="ex">1</span> error generated.</span>
<span id="cb104-154"><a href="#cb104-154" aria-hidden="true" tabindex="-1"></a>      <span class="ex">WARNING:__main__:Compilation</span> error: command <span class="st">&#39;/usr/bin/clang&#39;</span> failed with exit code 1</span>
<span id="cb104-155"><a href="#cb104-155" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:clang</span> <span class="at">-DNDEBUG</span> <span class="at">-fwrapv</span> <span class="at">-O2</span> <span class="at">-Wall</span> <span class="at">-fPIC</span> <span class="at">-O2</span> <span class="at">-isystem</span> ./envs/py3.11/include <span class="at">-arch</span> arm64 <span class="at">-fPIC</span> <span class="at">-O2</span> <span class="at">-isystem</span> ./envs/py3.11/include <span class="at">-arch</span> arm64 <span class="at">-I</span>/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/include <span class="at">-I</span>/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/pyfftw <span class="at">-I</span>/tmp-dir/pip-build-env-jifbhuv5/overlay/lib/python3.11/site-packages/numpy/core/include <span class="at">-I.</span>/envs/py3.11/include <span class="at">-I.</span>/envs/py3.11/include/python3.11 <span class="at">-c</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-hfaar1y4/fftw_plan_dft.c <span class="at">-o</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-hfaar1y4/fftw_plan_dft.o</span>
<span id="cb104-156"><a href="#cb104-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-157"><a href="#cb104-157" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:Checking</span> for fftw_plan_dft...no</span>
<span id="cb104-158"><a href="#cb104-158" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:objects:</span> []</span>
<span id="cb104-159"><a href="#cb104-159" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:libraries:</span> [<span class="st">&#39;fftw3f&#39;</span>]</span>
<span id="cb104-160"><a href="#cb104-160" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:include</span> dirs: [<span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/include&#39;</span>, <span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/pyfftw&#39;</span>, <span class="st">&#39;/tmp-dir/pip-build-env-jifbhuv5/overlay/lib/python3.11/site-packages/numpy/core/include&#39;</span>, <span class="st">&#39;./envs/py3.11/include&#39;</span>]</span>
<span id="cb104-161"><a href="#cb104-161" aria-hidden="true" tabindex="-1"></a>      <span class="ex">/var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-f8ktlj7y/fftwf_plan_dft.c:2:17:</span> error: implicit declaration of function <span class="st">&#39;fftwf_plan_dft&#39;</span> is invalid in C99 [-Werror,-Wimplicit-function-declaration]</span>
<span id="cb104-162"><a href="#cb104-162" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">fftwf_plan_dft()</span><span class="kw">;</span></span>
<span id="cb104-163"><a href="#cb104-163" aria-hidden="true" tabindex="-1"></a>                      <span class="ex">^</span></span>
<span id="cb104-164"><a href="#cb104-164" aria-hidden="true" tabindex="-1"></a>      <span class="ex">1</span> error generated.</span>
<span id="cb104-165"><a href="#cb104-165" aria-hidden="true" tabindex="-1"></a>      <span class="ex">WARNING:__main__:Compilation</span> error: command <span class="st">&#39;/usr/bin/clang&#39;</span> failed with exit code 1</span>
<span id="cb104-166"><a href="#cb104-166" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:clang</span> <span class="at">-DNDEBUG</span> <span class="at">-fwrapv</span> <span class="at">-O2</span> <span class="at">-Wall</span> <span class="at">-fPIC</span> <span class="at">-O2</span> <span class="at">-isystem</span> ./envs/py3.11/include <span class="at">-arch</span> arm64 <span class="at">-fPIC</span> <span class="at">-O2</span> <span class="at">-isystem</span> ./envs/py3.11/include <span class="at">-arch</span> arm64 <span class="at">-I</span>/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/include <span class="at">-I</span>/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/pyfftw <span class="at">-I</span>/tmp-dir/pip-build-env-jifbhuv5/overlay/lib/python3.11/site-packages/numpy/core/include <span class="at">-I.</span>/envs/py3.11/include <span class="at">-I.</span>/envs/py3.11/include/python3.11 <span class="at">-c</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-f8ktlj7y/fftwf_plan_dft.c <span class="at">-o</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-f8ktlj7y/fftwf_plan_dft.o</span>
<span id="cb104-167"><a href="#cb104-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-168"><a href="#cb104-168" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:Checking</span> for fftwf_plan_dft...no</span>
<span id="cb104-169"><a href="#cb104-169" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:objects:</span> []</span>
<span id="cb104-170"><a href="#cb104-170" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:libraries:</span> [<span class="st">&#39;fftw3l&#39;</span>]</span>
<span id="cb104-171"><a href="#cb104-171" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:include</span> dirs: [<span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/include&#39;</span>, <span class="st">&#39;/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/pyfftw&#39;</span>, <span class="st">&#39;/tmp-dir/pip-build-env-jifbhuv5/overlay/lib/python3.11/site-packages/numpy/core/include&#39;</span>, <span class="st">&#39;./envs/py3.11/include&#39;</span>]</span>
<span id="cb104-172"><a href="#cb104-172" aria-hidden="true" tabindex="-1"></a>      <span class="ex">/var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-nkofnks4/fftwl_plan_dft.c:2:17:</span> error: implicit declaration of function <span class="st">&#39;fftwl_plan_dft&#39;</span> is invalid in C99 [-Werror,-Wimplicit-function-declaration]</span>
<span id="cb104-173"><a href="#cb104-173" aria-hidden="true" tabindex="-1"></a>                      <span class="fu">fftwl_plan_dft()</span><span class="kw">;</span></span>
<span id="cb104-174"><a href="#cb104-174" aria-hidden="true" tabindex="-1"></a>                      <span class="ex">^</span></span>
<span id="cb104-175"><a href="#cb104-175" aria-hidden="true" tabindex="-1"></a>      <span class="ex">1</span> error generated.</span>
<span id="cb104-176"><a href="#cb104-176" aria-hidden="true" tabindex="-1"></a>      <span class="ex">WARNING:__main__:Compilation</span> error: command <span class="st">&#39;/usr/bin/clang&#39;</span> failed with exit code 1</span>
<span id="cb104-177"><a href="#cb104-177" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:clang</span> <span class="at">-DNDEBUG</span> <span class="at">-fwrapv</span> <span class="at">-O2</span> <span class="at">-Wall</span> <span class="at">-fPIC</span> <span class="at">-O2</span> <span class="at">-isystem</span> ./envs/py3.11/include <span class="at">-arch</span> arm64 <span class="at">-fPIC</span> <span class="at">-O2</span> <span class="at">-isystem</span> ./envs/py3.11/include <span class="at">-arch</span> arm64 <span class="at">-I</span>/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/include <span class="at">-I</span>/tmp-dir/pip-install-uosc4e24/pyfftw_cae63f92cf0343b4bb3308a3d5308afe/pyfftw <span class="at">-I</span>/tmp-dir/pip-build-env-jifbhuv5/overlay/lib/python3.11/site-packages/numpy/core/include <span class="at">-I.</span>/envs/py3.11/include <span class="at">-I.</span>/envs/py3.11/include/python3.11 <span class="at">-c</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-nkofnks4/fftwl_plan_dft.c <span class="at">-o</span> /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gr/T/pyfftw-nkofnks4/fftwl_plan_dft.o</span>
<span id="cb104-178"><a href="#cb104-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-179"><a href="#cb104-179" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:Checking</span> for fftwl_plan_dft...no</span>
<span id="cb104-180"><a href="#cb104-180" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DEBUG:__main__:{</span><span class="st">&#39;HAVE_DOUBLE&#39;</span><span class="ex">:</span> False, <span class="st">&#39;HAVE_DOUBLE_OMP&#39;</span>: False, <span class="st">&#39;HAVE_DOUBLE_THREADS&#39;</span>: False, <span class="st">&#39;HAVE_DOUBLE_MULTITHREADING&#39;</span>: False, <span class="st">&#39;HAVE_DOUBLE_MPI&#39;</span>: False, <span class="st">&#39;HAVE_SINGLE&#39;</span>: False, <span class="st">&#39;HAVE_SINGLE_OMP&#39;</span>: False, <span class="st">&#39;HAVE_SINGLE_THREADS&#39;</span>: False, <span class="st">&#39;HAVE_SINGLE_MULTITHREADING&#39;</span>: False, <span class="st">&#39;HAVE_SINGLE_MPI&#39;</span>: False, <span class="st">&#39;HAVE_LONG&#39;</span>: False, <span class="st">&#39;HAVE_LONG_OMP&#39;</span>: False, <span class="st">&#39;HAVE_LONG_THREADS&#39;</span>: False, <span class="st">&#39;HAVE_LONG_MULTITHREADING&#39;</span>: False, <span class="st">&#39;HAVE_LONG_MPI&#39;</span>: False, <span class="st">&#39;HAVE_MPI&#39;</span>: False}</span>
<span id="cb104-181"><a href="#cb104-181" aria-hidden="true" tabindex="-1"></a>      <span class="ex">error:</span> Could not find any of the FFTW libraries</span>
<span id="cb104-182"><a href="#cb104-182" aria-hidden="true" tabindex="-1"></a>      <span class="ex">[end</span> of output]</span>
<span id="cb104-183"><a href="#cb104-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-184"><a href="#cb104-184" aria-hidden="true" tabindex="-1"></a>  <span class="ex">note:</span> This error originates from a subprocess, and is likely not a problem with pip.</span>
<span id="cb104-185"><a href="#cb104-185" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ERROR:</span> Failed building wheel for pyfftw</span>
<span id="cb104-186"><a href="#cb104-186" aria-hidden="true" tabindex="-1"></a><span class="ex">Failed</span> to build pyfftw</span>
<span id="cb104-187"><a href="#cb104-187" aria-hidden="true" tabindex="-1"></a><span class="ex">ERROR:</span> Could not build wheels for pyfftw, which is required to install pyproject.toml-based projects</span></code></pre></div>
</details></li>
</ul>
<h2 id="sleep">Sleep</h2>
<p>Sleeping with <code>time.sleep()</code> is <a
href="https://stackoverflow.com/questions/1133857/how-accurate-is-pythons-time-sleep">not
very accurate</a>. This causes various FPS tests to fail. See that
thread (and the code in <code>misc/PlotSleepBehavior.py</code>) for some
possible solutions.</p>
<ul>
<li><p>How to manage one definitive version? The <a
href="https://github.com/python-poetry/poetry/pull/2366#issuecomment-652418094">current
suggestion</a> is to use <code>importlib.metadata</code>:</p>
<div class="sourceCode" id="cb105"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># __init__.py</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> importlib.metadata <span class="im">as</span> _metadata</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> ModuleNotFoundError:</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> _metadata</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>__version__ <span class="op">=</span> _metadata.version(<span class="va">__name__</span>)</span></code></pre></div>
<div class="sourceCode" id="cb106"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pyproject.toml</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[</span><span class="dt">tool</span><span class="kw">.</span><span class="dt">poetry</span><span class="kw">.</span><span class="dt">dependencies</span><span class="kw">]</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a><span class="er">...</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="dt">importlib-metadata</span> <span class="op">=</span> <span class="op">{</span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;^1.0&quot;</span><span class="op">, </span><span class="dt">python</span><span class="op"> =</span> <span class="st">&quot;&lt;3.8&quot;</span><span class="op">}</span></span></code></pre></div>
<p>If you only support Python &gt;= 3.8, then you can simply do:</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># __init__.py</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> importlib.metadata <span class="im">as</span> _metadata</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a>__version__ <span class="op">=</span> _metadata.version(<span class="va">__name__</span>)</span></code></pre></div>
<p>This works for installed packages, but fails when one just adds the
source directory to the path:</p>
<div class="sourceCode" id="cb108"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd src</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python <span class="at">-c</span> <span class="st">&quot;import mmfutils</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="st">Traceback (most recent call last):</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="st">   ...</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="st">importlib.metadata.PackageNotFoundError: mmfutils</span></span></code></pre></div>
<p>The work-around is as follows. (We could fallback to VCS maybe? Or
look in <a
href="https://packaging.python.org/en/latest/specifications/declaring-project-metadata"><code>pyproject.toml</code></a>?).</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    __version__ <span class="op">=</span> _metadata.version(<span class="va">__name__</span>)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> _metadata.PackageNotFoundError:</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    __version__ <span class="op">=</span> <span class="st">&quot;&lt;unknown source distribution&gt;&quot;</span>    </span></code></pre></div></li>
</ul>
<ul>
<li><a
href="https://github.com/python-poetry/poetry/issues/1724">Document use
of current conda env #1724</a></li>
<li><a href="https://github.com/python-poetry/poetry/issues/697">Ability
to override/ignore sub-dependencies #697</a>: What to do when
sub-dependencies do not properly specify requirements, leading to
conflicts. (Not sure of the actual resolution.)</li>
<li><a href="https://github.com/python-poetry/poetry/issues/4033">Poetry
install tries to update system packages is ‘system-site-packages’ option
enabled #4033</a></li>
</ul>
<h1 id="cocalc"><a href="https://cocalc.com">CoCalc</a></h1>
<p>We make fairly heavy use of <a href="https://cocalc.com">CoCalc</a>
for online computations and collaboration. Thus, we try to include a
mechanism for easily building and running our software on that platform.
Here are a couple of principles:</p>
<ul>
<li><p><a href="https://cocalc.com">CoCalc</a> comes with a few fairly
complete software environments that can be enabled by running
<code>anaconda2020</code> or <code>anaconda2021</code>. Corresponding
Jupyter kernels exist, so these are natural choices. If possible, I
recommend that simple projects just use these – especially if they will
be shared with many people who might not want to install software
(i.e. students in a lower-level or non-programming course).</p>
<p>This has the added advantage of allowing users to work on unpaid
projects: these have no network access, so cannot install software.</p>
<p>Caveat: Including many packages forces some packages like <a
href="https://scipy.org/">SciPy</a> to fairly low versions (see issue <a
href="https://github.com/sagemathinc/cocalc/issues/6391">cocalc#6391</a>).
This means you might not be able to depend on the latest features.
Hopefully this will be resolved with <code>anaconda2022</code>. To see
which versions are included, look at <a
href="https://cocalc.com/software/python"
class="uri">https://cocalc.com/software/python</a>.</p></li>
<li><p><a href="https://cocalc.com">CoCalc</a> projects typically have
limited memory (1-2GB), which can pose a problem for <a
href="https://docs.conda.io" title="Conda">conda</a>. In particular,
<strong>do not</strong> just try run <a href="https://docs.conda.io"
title="Conda">conda</a> from one of the <code>anaconda*</code>
environments without disabling channels:</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode bash"><code class="sourceCode bash"></code></pre></div>
<p>. They include so many channels that even a simple
<code>conda search</code> is likely to run out of memory.</p>
<p>There are several mitigation strategies:</p>
<ul>
<li><p>Directly call the executable:</p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="ex">/ext/anaconda2021.11/bin/conda</span></span></code></pre></div></li>
<li><p>Install and use <a
href="https://mamba.readthedocs.io/en/latest/user_guide/micromamba.html">micromamba</a>:</p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-Ls</span> https://micro.mamba.pm/api/micromamba/linux-64/latest <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>         <span class="fu">tar</span> <span class="at">-xvj</span> bin/micromamba <span class="at">-O</span> <span class="op">&gt;</span> ~/.local/bin/micromamba</span></code></pre></div></li>
</ul></li>
</ul>
<h2 id="implementation-details">Implementation Details</h2>
<p><strong>Detecting CoCalc</strong>: Currently we use the presence of
the environmental variable <code>ANACONDA2020</code> to determine if we
are on <a href="https://cocalc.com">CoCalc</a>. *(In the <a
href="https://github.com/sagemathinc/cocalc/issues/5483">future</a>,
<code>ANACONDA_CURRENT</code> will point to the latest release. It might
be better to use this in case <code>ANACONDA2020</code> is
deprecated.)</p>
<p><strong>PATH</strong>: <code>~/.local/bin</code> is included in the
path, so this is where to put/symlink executables. Note, however, that
this is only included for login shells. If you put things (like <a
href="https://www.mercurial-scm.org/">mercurial</a>) there that are
needed over ssh, then you need to modify <code>~/.bashrc</code> so these
are added. We do this with [mmf_setup][], moving the default
<code>~/.bashrc</code> to <code>~/.bashrc_cocalc</code>:</p>
<div class="sourceCode" id="cb113"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ~/.bashrc</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span><span class="st">&quot;~/.local/bin/:</span><span class="va">$PATH</span><span class="st">&quot;</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="bu">[</span> <span class="ot">-f</span> ~/.bashrc_cocalc <span class="bu">]</span> <span class="kw">&amp;&amp;</span> <span class="bu">.</span> ~/.bashrc_cocalc</span></code></pre></div>
<p><a href="https://cocalc.com">CoCalc</a> follows the common linux
practice of sourcing <code>~/.bash_aliases</code>, so we put the rest of
our customizations there.</p>
<p><strong>VCS</strong>: One issue with <a
href="https://cocalc.com">CoCalc</a> is that all users share the same
account. Thus, there is no easy way to tell who is logged in for
purposes like committing code to VCS. To deal with this, we abuse this
by See <a
href="https://github.com/sagemathinc/cocalc/issues/370">cocalc#370</a>
for details.</p>
<h1 id="reference">Reference</h1>
<h2 id="conda-issues">Conda Issues</h2>
<ul>
<li><a href="https://github.com/conda/conda/issues/1329"><img
src="https://img.shields.io/github/issues/detail/state/conda/conda/1329"
alt="Issue" /></a> “Better support for conda envs accessed by multiple
users”</li>
<li><a href="https://github.com/conda/conda/issues/6991"><img
src="https://img.shields.io/github/issues/detail/state/conda/conda/6991"
alt="Issue" /></a> “conda env create -f hangs if yaml is on read-only
network share”</li>
<li><a href="https://github.com/conda/conda/issues/7227"><img
src="https://img.shields.io/github/issues/detail/state/conda/conda/7227"
alt="Issue" /></a> “Write permission error with a shared package cache
folder.”</li>
<li><a href="https://github.com/conda/conda/issues/7279"><img
src="https://img.shields.io/github/issues/detail/state/conda/conda/7279"
alt="Issue" /></a> “conda env update –prune does not remove installed
packages not defined in environment.yml”</li>
<li><a href="https://github.com/conda/conda/issues/8592"><img
src="https://img.shields.io/github/issues/detail/state/conda/conda/8592"
alt="Issue" /></a> “It takes a couple of minutes to run conda
commands”</li>
<li><a href="https://github.com/conda/conda/issues/8983"><img
src="https://img.shields.io/github/issues/detail/state/conda/conda/8983"
alt="Issue" /></a> “conda fails install for local user due to permission
issues”</li>
<li><a href="https://github.com/conda/conda/issues/10690"><img
src="https://img.shields.io/github/issues/detail/state/conda/conda/10690"
alt="Issue" /></a> “Conda run fails with Permission denied if
environment is read-only.”</li>
<li><a href="https://github.com/conda/conda/issues/10105"><img
src="https://img.shields.io/github/issues/detail/state/conda/conda/10105"
alt="Issue" /></a> “Local environment.yml file hides remote environment
file specification in conda env create.”
<ul>
<li>Could be an issue with <code>anaconda-client</code>: <a
href="https://github.com/Anaconda-Platform/anaconda-client/issues/549"><img
src="https://img.shields.io/github/issues/detail/state/Anaconda-Platform/anaconda-client/549"
alt="Issue" /></a></li>
</ul></li>
</ul>
<h2 id="black-issues">Black Issues</h2>
<ul>
<li><a href="https://github.com/drillan/jupyter-black/issues/26"><img
src="https://img.shields.io/github/issues/detail/state/drillan/jupyter-black/26"
alt="Issue" /></a> “Black is needed in the kernel, not the environment
running jupyter, but the reverse is preferred.”</li>
</ul>
<h2 id="pdm-issues">PDM Issues</h2>
<ul>
<li><a href="https://github.com/pdm-project/pdm/issues/1606"><img
src="https://img.shields.io/github/issues/detail/state/pdm-project/pdm/1606"
alt="Issue" /></a> “install development groups into separate
environments”. This issue addresses a similar question related to
installing development groups as separate environments. This was closed
as not going to be supported in the core, but maybe in a plugin.</li>
</ul>
<h2 id="poetry-issues">Poetry Issues</h2>
<ul>
<li><a href="https://github.com/python-poetry/poetry/issues/1724"><img
src="https://img.shields.io/github/issues/detail/state/python-poetry/poetry/1724"
alt="Issue" /></a> “Document use of current conda env”</li>
</ul>
<h2 id="pipx-issues">PipX Issues</h2>
<ul>
<li><a href="https://github.com/pypa/pipx/issues/934"><img
src="https://img.shields.io/github/issues/detail/state/pypa/pipx/934"
alt="Issue" /></a> “Support for
<code>pipx inject &lt;package&gt; -r &lt;requirements-file&gt;</code>”</li>
</ul>
<h2 id="condax-issues">CondaX Issues</h2>
<ul>
<li><a href="https://github.com/mariusvniekerk/condax/issues/16"><img
src="https://img.shields.io/github/issues/detail/state/mariusvniekerk/condax/16"
alt="Issue" /></a> “Scriptable (commandline) customization of
CONDAX_LINK_DESTINATION (link_destination)”</li>
<li><a href="https://github.com/mariusvniekerk/condax/issues/63"><img
src="https://img.shields.io/github/issues/detail/state/mariusvniekerk/condax/63"
alt="Issue" /></a> “Allow specifying Python version when installing a
package (i.e. –python flag)”</li>
</ul>
<h2 id="cocalc-issues">CoCalc Issues</h2>
<ul>
<li><a href="https://github.com/sagemathinc/cocalc/issues/370"><img
src="https://img.shields.io/github/issues/detail/state/sagemathinc/cocalc/370"
alt="Issue" /></a> “Version Control with SMC”</li>
<li><a href="https://github.com/sagemathinc/cocalc/issues/6391"><img
src="https://img.shields.io/github/issues/detail/state/sagemathinc/cocalc/6391"
alt="Issue" /></a> “Scipy regression with anaconda progression?”</li>
</ul>
<p>https://discussions.apple.com/thread/254891544</p>
<h1 id="odds-and-ends">Odds and Ends</h1>
<p>Consider using <a
href="https://www.toptal.com/developers/gitignore/api/latex,python">gitignore.io</a>
to generate <code>.gitignore</code> and <code>.hgignore</code>
files.</p>
<p>When trying to use <code>pyenv</code> I get the following error:</p>
<div class="sourceCode" id="cb114"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> pyenv install 3.6.12</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Downloading</span> openssl-1.1.0j.tar.gz...</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-</span><span class="op">&gt;</span> https://www.openssl.org/source/old/1.1.0/openssl-1.1.0j.tar.gz</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Installing</span> openssl-1.1.0j...</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Installed</span> openssl-1.1.0j to /Users/mforbes/.pyenv/versions/3.6.12</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Downloading</span> readline-8.0.tar.gz...</span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a><span class="ex">-</span><span class="op">&gt;</span> https://ftpmirror.gnu.org/readline/readline-8.0.tar.gz</span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Installing</span> readline-8.0...</span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Installed</span> readline-8.0 to /Users/mforbes/.pyenv/versions/3.6.12</span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a><span class="ex">Downloading</span> Python-3.6.12.tar.xz...</span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a><span class="ex">-</span><span class="op">&gt;</span> https://www.python.org/ftp/python/3.6.12/Python-3.6.12.tar.xz</span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a><span class="ex">Installing</span> Python-3.6.12...</span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a><span class="ex">python-build:</span> use zlib from xcode sdk</span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a><span class="ex">BUILD</span> FAILED <span class="er">(</span><span class="ex">OS</span> X 10.14.6 using python-build 20180424<span class="kw">)</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a><span class="ex">Inspect</span> or clean up the working tree at /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gp/T/python-build.20210427233639.16374</span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a><span class="ex">Results</span> logged to /var/folders/m7/dnr91tjs4gn58_t3k8zp_g000000gp/T/python-build.20210427233639.16374.log</span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a><span class="ex">Last</span> 10 log lines:</span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;_libintl_textdomain&quot;</span><span class="ex">,</span> referenced from:</span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>      <span class="ex">_PyIntl_textdomain</span> in libpython3.6m.a<span class="er">(</span><span class="ex">_localemodule.o</span><span class="kw">)</span></span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>      <span class="ex">_PyIntl_textdomain</span> in libpython3.6m.a<span class="er">(</span><span class="ex">_localemodule.o</span><span class="kw">)</span></span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a><span class="ex">ld:</span> symbol<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="ex">not</span> found for architecture x86_64</span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a><span class="ex">ld:</span> symbol<span class="er">(</span><span class="ex">s</span><span class="kw">)</span> <span class="ex">not</span> found for architecture x86_64</span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a><span class="ex">clang:</span> error: linker command failed with exit code 1 <span class="er">(</span><span class="ex">use</span> <span class="at">-v</span> to see invocation<span class="kw">)</span></span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a><span class="ex">clang:</span> error: linker command failed with exit code 1 <span class="er">(</span><span class="ex">use</span> <span class="at">-v</span> to see invocation<span class="kw">)</span></span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a><span class="ex">make:</span> <span class="pp">***</span> [Programs/_testembed] Error 1</span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a><span class="ex">make:</span> <span class="pp">***</span> Waiting for unfinished jobs....</span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a><span class="ex">make:</span> <span class="pp">***</span> [python.exe] Error 1</span></code></pre></div>
<h1 id="references-3">References</h1>
<ul>
<li><a
href="https://hynek.me/articles/python-recursive-optional-dependencies/">Recursive
Optional Dependencies in Python</a> (Hynek Schlawack):</li>
</ul>
<!-- Links -->
</body>
</html>
